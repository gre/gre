<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="author" content="Gaëtan Renaudeau"/><meta name="description" content="One week ago, I’ve released a web experiment featuring a collaborative Paint-like application made with Play Framework 2 and relying on WebSocket and HTML5 Canvas. Here is how I&#x27;ve improved it."/><meta name="keywords" content="canvas, playframework, websocket, javascript"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@greweb"/><meta name="twitter:title" content="Play Painter – how i&#x27;ve improved the 30 minutes prototyped version"/><meta name="og:title" content="Play Painter – how i&#x27;ve improved the 30 minutes prototyped version"/><meta name="twitter:description" content="One week ago, I’ve released a web experiment featuring a collaborative Paint-like application made with Play Framework 2 and relying on WebSocket and HTML5 Canvas. Here is how I&#x27;ve improved it."/><meta name="twitter:creator" content="@greweb"/><meta name="og:image" content="http://greweb.me//images/2012/03/twitt_playpainter.png"/><meta name="twitter:image" content="http://greweb.me//images/2012/03/twitt_playpainter.png"/><link rel="image_src" href="http://greweb.me//images/2012/03/twitt_playpainter.png"/><title>@greweb - Play Painter – how i&#x27;ve improved the 30 minutes prototyped version</title><link href="http://fonts.googleapis.com/css?family=Fredericka+the+Great|Arapey|Roboto:400,700,400italic" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/styles/default.min.css"/><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/highlight.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/javascript.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/cpp.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/glsl.min.js"></script><link rel="stylesheet" href="/style/main.css"/><meta name="next-head-count" content="25"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-c914a1e31212c00c738a.js" defer=""></script><script src="/_next/static/chunks/framework-bdc1b4e5e48979e16d36.js" defer=""></script><script src="/_next/static/chunks/main-3b0c517193ca5150f81f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c981e0e3ce59f13eb8d0.js" defer=""></script><script src="/_next/static/chunks/5988-738c1ea5f97353b6463e.js" defer=""></script><script src="/_next/static/chunks/2242-eb3b6e81e9125c246631.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-476d7e87469cc8a40c59.js" defer=""></script><script src="/_next/static/U2t60rVT7QXGvI-bQnIso/_buildManifest.js" defer=""></script><script src="/_next/static/U2t60rVT7QXGvI-bQnIso/_ssgManifest.js" defer=""></script><style id="__jsx-2519965637">.block.jsx-2519965637{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.block.jsx-2519965637 .right.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637{margin-top:10px;}.block.jsx-2519965637 .social.jsx-2519965637 a.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637 img.jsx-2519965637{height:20px;}</style><style id="__jsx-3621368397">.container.jsx-3621368397{min-height:100vh;padding:0 0.5rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style id="__jsx-3469673304">html,body{padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}*{box-sizing:border-box;}a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}a:hover,a:active{-webkit-text-decoration:underline;text-decoration:underline;}</style></head><body><div id="__next"><div class="jsx-3621368397 container"><div id="container"><div id="main"><div id="content"><article><header><h1><a href="/">Play Painter – how i&#x27;ve improved the 30 minutes prototyped version</a></h1><time class="date" dateTime="2012-03-17">2012-03-17</time><span class="tags"><a class="tag">canvas</a><a class="tag">playframework</a><a class="tag">websocket</a><a class="tag">javascript</a></span></header><div class="entry-content"><p>One week ago, I’ve released a <a href="/2012/03/30-minutes-to-make-a-multi-user-real-time-paint-with-play-2-framework-canvas-and-websocket/">technical web experiment</a> featuring <strong>a collaborative real-time Paint-like application I’ve called Play Painter</strong>. It has been made with <a href="http://playframework.org/">Play Framework 2</a> and rely on WebSocket and HTML5 Canvas Javascript APIs.</p>
<p>Thanks to everyone having tested my Play Painter experiment, you helped me figure out bugs and bottlenecks and to benchmark the application running on my tiny server.<br>The first version of Play Painter has been improved with some optimizations.</p>
<p>Explanation…</p>
<blockquote class="twitter-tweet" lang="fr"><p>Thanks guys for testing playpainter! but you are breaking my server :D <a href="http://t.co/F62qwk1i" title="http://twitter.com/greweb/status/179194592481116160/photo/1">twitter.com/greweb/status/…</a></p>&mdash; Gaëtan Renaudeau (@greweb) <a href="https://twitter.com/greweb/status/179194592481116160">12 mars 2012</a></blockquote>

<!--more-->

<h2 id="in-brief">In brief</h2>
<ul>
<li><strong>80 twitts</strong>, <strong>3500 unique visitors</strong> in a few days.</li>
<li>a peak of about <strong>80 simultaneous painters</strong>.</li>
<li>about <strong>200 WebSocket messages per second</strong> when 3-4 users are drawing =&gt; bottleneck found.</li>
<li>when it occurs, 100% CPU and about <strong>1500 system interrupts per second</strong> on my poor Atom 1.2 Ghz server.</li>
</ul>
<h2 id="some-reasons">Some reasons</h2>
<p>The initial version of Play Painter was a basic fast-prototyped version:</p>
<p>First, It was <strong>spreading every mouse events</strong> (down, up, move) to all clients <strong>as fast as it comes</strong>. It means that, depending on the computer and browser performance, a huge number of events could have been triggered and spread to all connected users.</p>
<p>We solved this by <strong>Chunking draw events</strong>.</p>
<p>Second, <strong>a lot of informations was repeated in WebSocket messages.</strong> No datas were stored on the server-side so to be sure a new user see the right draws, player name, brush color and size was sent in every message. Multiply this by the number of mouse events and you get a lot of useless information!</p>
<p>We are now <strong>Storing painters information</strong>.</p>
<h2 id="chunking-draw-events">Chunking draw events</h2>
<p>When an user starts drawing, mouse events give the brush positions (x, y). But instead of sending a websocket message for each of these new positions, they are stored, and every <strong>X</strong> milliseconds, are sent in a websocket message. Such message contains all points of the draw from the last sent draw message.</p>
<p>The <strong>X</strong> value has currently been fixed to <strong>50 milliseconds</strong> because it’s enough for the human eye: It means about 20 messages per second for one painter. In movies we usually have a 24 frame rate.</p>
<p>The same principle has been applied on the painter brush positions.</p>
<h3 id="example">Example</h3>
<p><strong>Before</strong><br>13 WebSocket messages:</p>
<pre><code class="language-javascript">{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:181,&quot;y&quot;:259,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:183,&quot;y&quot;:259,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:184,&quot;y&quot;:257,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:187,&quot;y&quot;:257,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:188,&quot;y&quot;:257,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:191,&quot;y&quot;:256,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:192,&quot;y&quot;:255,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:192,&quot;y&quot;:255,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:192,&quot;y&quot;:254,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:193,&quot;y&quot;:254,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:195,&quot;y&quot;:254,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:196,&quot;y&quot;:253,&quot;pid&quot;:19}
{&quot;type&quot;:&quot;lineTo&quot;,&quot;x&quot;:196,&quot;y&quot;:253,&quot;pid&quot;:19}
</code></pre>
<p><strong>After</strong><br>2 WebSocket messages: (50 ms apart)</p>
<pre><code class="language-javascript">{&quot;type&quot;:&quot;trace&quot;,&quot;points&quot;:[{&quot;x&quot;:181,&quot;y&quot;:259},{&quot;x&quot;:183,&quot;y&quot;:259},{&quot;x&quot;:184,&quot;y&quot;:257},{&quot;x&quot;:187,&quot;y&quot;:257},{&quot;x&quot;:188,&quot;y&quot;:257},{&quot;x&quot;:191,&quot;y&quot;:256},{&quot;x&quot;:192,&quot;y&quot;:255}],&quot;pid&quot;:19}
{&quot;type&quot;:&quot;trace&quot;,&quot;points&quot;:[{&quot;x&quot;:192,&quot;y&quot;:255},{&quot;x&quot;:192,&quot;y&quot;:254},{&quot;x&quot;:193,&quot;y&quot;:254},{&quot;x&quot;:195,&quot;y&quot;:254},{&quot;x&quot;:195,&quot;y&quot;:253},{&quot;x&quot;:196,&quot;y&quot;:253},{&quot;x&quot;:196,&quot;y&quot;:253}],&quot;pid&quot;:19}
</code></pre>
<h3 id="to-a-variable-frame-rate">To a variable frame rate?</h3>
<p>I am also thinking about a variable rate depending of the number of active painters. In fact, the more we have painters, the more we will have messages, and the more the server will have system interrupts, we could then decrease the frame rate per second to reduce this load.</p>
<p>The problem of this extreme approach is the degradation of the feeling of real-time.</p>
<p>For now, I’m keeping the constant frame rate version, we will see how far it goes.</p>
<h2 id="storing-painters-information">Storing painters information</h2>
<p>As I said, <strong>a lot of informations was repeated in WebSocket messages.</strong> In every draw events, painter name, brush size and brush color was sent from the client to the server, and the spread into all connected clients.</p>
<p>This was ok for prototyping but we have now optimize this by storing these painter generic informations in the server and sending them when a new WebSocket connection is opened.</p>
<h3 id="example-1">Example</h3>
<p>This is what a client can receive when a websocket is connected:</p>
<pre><code class="language-javascript">{&quot;type&quot;:&quot;youAre&quot;,&quot;pid&quot;:24}
{&quot;name&quot;:&quot;john&quot;,&quot;color&quot;:&quot;red&quot;,&quot;size&quot;:5,&quot;type&quot;:&quot;painter&quot;,&quot;pid&quot;:21}
{&quot;name&quot;:&quot;gre&quot;,&quot;color&quot;:&quot;red&quot;,&quot;size&quot;:5,&quot;type&quot;:&quot;painter&quot;,&quot;pid&quot;:24}
{&quot;name&quot;:&quot;peter&quot;,&quot;color&quot;:&quot;red&quot;,&quot;size&quot;:5,&quot;type&quot;:&quot;painter&quot;,&quot;pid&quot;:4}
{&quot;name&quot;:&quot;paul&quot;,&quot;color&quot;:&quot;red&quot;,&quot;size&quot;:5,&quot;type&quot;:&quot;painter&quot;,&quot;pid&quot;:6}
{&quot;name&quot;:&quot;jack&quot;,&quot;color&quot;:&quot;red&quot;,&quot;size&quot;:5,&quot;type&quot;:&quot;painter&quot;,&quot;pid&quot;:2}
</code></pre>
<p>and then…</p>
<pre><code>{&quot;type&quot;:&quot;trace&quot;,&quot;points&quot;:[{&quot;x&quot;:181,&quot;y&quot;:259},{&quot;x&quot;:183,&quot;y&quot;:259},{&quot;x&quot;:184,&quot;y&quot;:257}],&quot;pid&quot;:19}
...
</code></pre>
<p>By knowing all painter properties, when someone will draw something, he will not have to repeat which color and size its brush has.</p>
<h3 id="server-side">Server side</h3>
<p>It was quite interesting to implement the server part with <a href="https://github.com/playframework/Play20/wiki/Iteratees">Play2′s Iteratees</a>, a new way of handling I/O – not so new in fact because it is directly related to Haskell Iteratee concepts.</p>
<p>To implement a WebSocket connection, you will provide an <strong>Iteratee</strong> for consuming the <strong>input</strong> and an <strong>Enumerator</strong> for producing the <strong>output</strong>.</p>
<p>Enumerator are chainable, this is how I firstly send the painter id and painters informations:</p>
<pre><code class="language-scala">// out: handle messages to send to the painter
val out =
  // Inform the painter who he is (which pid, he can them identify himself)
  Enumerator(JsObject(Seq(&quot;type&quot; -&gt; JsString(&quot;youAre&quot;), &quot;pid&quot; -&gt; JsNumber(pid))).as[JsValue]) &gt;&gt;&gt;
  // Inform the list of other painters
  Enumerator(painters.map { case (id, painter) =&gt;
    (painter.toJson JsObject(Seq(&quot;type&quot; -&gt; JsString(&quot;painter&quot;), &quot;pid&quot; -&gt; JsNumber(id)))).as[JsValue]
  } toList : _*) &gt;&gt;&gt;
  // Stream the hub
  hub.getPatchCord()
</code></pre>
<p>The <strong>&gt;&gt;&gt;</strong> operator is a shortcut to the <strong>andThen</strong> method which is the way to chain enumerators.</p>
<p>For more details, <a href="https://github.com/gre/playpainter/blob/master/scala/app/controllers/Application.scala">see the scala code of the controller</a>.</p>
<h2 id="other-features">Other features</h2>
<p>The application has been improved in many other ways.</p>
<ul>
<li><strong>A “buffering” Canvas</strong> in the foreground has been add <strong>for the user draws</strong>. It brings client-side reactivity and helps to avoid unpleasant lag feeling when drawing. When the user draw events are coming from the server and no other user events has been sent since, it’s synchronized and we can clean this buffer.</li>
<li><strong>Painter positions are show with their names</strong>.</li>
<li>It should now work properly on <strong>smartphones and tablets</strong>. Try on iPad and iPhone, and maybe on recent version of Android (WebSocket support required).</li>
<li><strong>Keyboard shortcut</strong>: using arrows to change brush size and color.</li>
<li>The <strong><a href="http://github.com/gre/playpainter">source code</a> has been polished and commented</strong> especially the server side part (it’s probably the hardest part if you don’t know Play framework).</li>
<li>Error message displayed when a technology is not supported and when the WebSocket connection goes down (with a reconnecting try loop).</li>
</ul>
<h2 id="the-demo-is-still-online">The demo is still online!</h2>
<p><strong><a href="http://playpainter.greweb.fr/">playpainter.greweb.fr</a></strong></p>
<h2 id="future">Future</h2>
<p>With these two optimizations, I’ve reduce the global <strong>number of socket messages</strong> and also the <strong>size of each message</strong>.</p>
<p>The first benchmark sounds good, 3 painters was simultaneously crazily painting while the server application was only using less than 10% of CPU.</p>
<p>Now, the most challenging part would be to scale the application to a huge number of connections, but having maybe solved this bottleneck, it’s maybe now more a matter of system architecture than the application itself.</p>
<p>This experiment gave me a lot of interest in <strong>WebSocket</strong> and also in <strong>the powerful way WebSockets are handled in Play framework</strong>.</p>
<p>If anyone want to start a Java version of the application, please go on! <a href="https://github.com/gre/playpainter/issues/1">(this was requested on Github)</a></p>
<p>Thanks to <a href="https://twitter.com/dbathily">@dbathily</a>, we know have both Scala and Java version!</p>
<h3 id="next-experiment">Next experiment</h3>
<p>I am thinking about making a multiplayer game on the web.<br>It would be something like a shooter survival game (like Counter Strike Zombie Mod) a multi-plateform 2D side view game (like Mario) !</p>
<p>You will know more about this soon!</p>
</div><footer><div class="jsx-2519965637 block"><img src="http://greweb.me/logo.svg" width="100" class="jsx-2519965637"/><div class="jsx-2519965637 right"><div class="jsx-2519965637 description">As a generative plotter artist, I use code to generate art (creative coding) and physically create it with pen plotters, which is itself a generative process – each physical plot is a unique variant. I love dualities, like digital vs analog physical, abstract vs figurative, orthogonal vs polar, photo vs noise,...</div><div class="jsx-2519965637 social"><a href="https://discord.gg/DQBajxzn" class="jsx-2519965637"><img alt="" src="/icons/discord.svg" class="jsx-2519965637"/></a><a href="https://twitter.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitter.svg" class="jsx-2519965637"/></a><a href="https://instagram.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/instagram.svg" class="jsx-2519965637"/></a><a href="https://twitch.tv/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitch.svg" class="jsx-2519965637"/></a><a href="https://github.com/gre" class="jsx-2519965637"><img alt="" src="/icons/github.svg" class="jsx-2519965637"/></a><a href="https://youtube.com/@greweb" class="jsx-2519965637"><img alt="" src="/icons/youtube.svg" class="jsx-2519965637"/></a><a href="https://opensea.io/greweb?tab=created" class="jsx-2519965637"><img alt="" src="/icons/eth.svg" class="jsx-2519965637"/></a><a href="https://fxhash.xyz/u/greweb" class="jsx-2519965637"><img alt="" src="/icons/tz.svg" class="jsx-2519965637"/></a><a href="https://greweb.itch.io" class="jsx-2519965637"><img alt="" src="/icons/iconmonstr-gamepad-3.svg" class="jsx-2519965637"/></a></div></div></div></footer></article></div></div></div><script>hljs.highlightAll();</script></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"2012-03-17-play-painter-how-ive-improved-the-30-minutes-prototyped-version","year":"2012","month":"03","day":"17","slug":"play-painter-how-ive-improved-the-30-minutes-prototyped-version","content":"\u003cp\u003eOne week ago, I’ve released a \u003ca href=\"/2012/03/30-minutes-to-make-a-multi-user-real-time-paint-with-play-2-framework-canvas-and-websocket/\"\u003etechnical web experiment\u003c/a\u003e featuring \u003cstrong\u003ea collaborative real-time Paint-like application I’ve called Play Painter\u003c/strong\u003e. It has been made with \u003ca href=\"http://playframework.org/\"\u003ePlay Framework 2\u003c/a\u003e and rely on WebSocket and HTML5 Canvas Javascript APIs.\u003c/p\u003e\n\u003cp\u003eThanks to everyone having tested my Play Painter experiment, you helped me figure out bugs and bottlenecks and to benchmark the application running on my tiny server.\u003cbr\u003eThe first version of Play Painter has been improved with some optimizations.\u003c/p\u003e\n\u003cp\u003eExplanation…\u003c/p\u003e\n\u003cblockquote class=\"twitter-tweet\" lang=\"fr\"\u003e\u003cp\u003eThanks guys for testing playpainter! but you are breaking my server :D \u003ca href=\"http://t.co/F62qwk1i\" title=\"http://twitter.com/greweb/status/179194592481116160/photo/1\"\u003etwitter.com/greweb/status/…\u003c/a\u003e\u003c/p\u003e\u0026mdash; Gaëtan Renaudeau (@greweb) \u003ca href=\"https://twitter.com/greweb/status/179194592481116160\"\u003e12 mars 2012\u003c/a\u003e\u003c/blockquote\u003e\n\n\u003c!--more--\u003e\n\n\u003ch2 id=\"in-brief\"\u003eIn brief\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e80 twitts\u003c/strong\u003e, \u003cstrong\u003e3500 unique visitors\u003c/strong\u003e in a few days.\u003c/li\u003e\n\u003cli\u003ea peak of about \u003cstrong\u003e80 simultaneous painters\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eabout \u003cstrong\u003e200 WebSocket messages per second\u003c/strong\u003e when 3-4 users are drawing =\u0026gt; bottleneck found.\u003c/li\u003e\n\u003cli\u003ewhen it occurs, 100% CPU and about \u003cstrong\u003e1500 system interrupts per second\u003c/strong\u003e on my poor Atom 1.2 Ghz server.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"some-reasons\"\u003eSome reasons\u003c/h2\u003e\n\u003cp\u003eThe initial version of Play Painter was a basic fast-prototyped version:\u003c/p\u003e\n\u003cp\u003eFirst, It was \u003cstrong\u003espreading every mouse events\u003c/strong\u003e (down, up, move) to all clients \u003cstrong\u003eas fast as it comes\u003c/strong\u003e. It means that, depending on the computer and browser performance, a huge number of events could have been triggered and spread to all connected users.\u003c/p\u003e\n\u003cp\u003eWe solved this by \u003cstrong\u003eChunking draw events\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eSecond, \u003cstrong\u003ea lot of informations was repeated in WebSocket messages.\u003c/strong\u003e No datas were stored on the server-side so to be sure a new user see the right draws, player name, brush color and size was sent in every message. Multiply this by the number of mouse events and you get a lot of useless information!\u003c/p\u003e\n\u003cp\u003eWe are now \u003cstrong\u003eStoring painters information\u003c/strong\u003e.\u003c/p\u003e\n\u003ch2 id=\"chunking-draw-events\"\u003eChunking draw events\u003c/h2\u003e\n\u003cp\u003eWhen an user starts drawing, mouse events give the brush positions (x, y). But instead of sending a websocket message for each of these new positions, they are stored, and every \u003cstrong\u003eX\u003c/strong\u003e milliseconds, are sent in a websocket message. Such message contains all points of the draw from the last sent draw message.\u003c/p\u003e\n\u003cp\u003eThe \u003cstrong\u003eX\u003c/strong\u003e value has currently been fixed to \u003cstrong\u003e50 milliseconds\u003c/strong\u003e because it’s enough for the human eye: It means about 20 messages per second for one painter. In movies we usually have a 24 frame rate.\u003c/p\u003e\n\u003cp\u003eThe same principle has been applied on the painter brush positions.\u003c/p\u003e\n\u003ch3 id=\"example\"\u003eExample\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eBefore\u003c/strong\u003e\u003cbr\u003e13 WebSocket messages:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:181,\u0026quot;y\u0026quot;:259,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:183,\u0026quot;y\u0026quot;:259,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:184,\u0026quot;y\u0026quot;:257,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:187,\u0026quot;y\u0026quot;:257,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:188,\u0026quot;y\u0026quot;:257,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:191,\u0026quot;y\u0026quot;:256,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:192,\u0026quot;y\u0026quot;:255,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:192,\u0026quot;y\u0026quot;:255,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:192,\u0026quot;y\u0026quot;:254,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:193,\u0026quot;y\u0026quot;:254,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:195,\u0026quot;y\u0026quot;:254,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:196,\u0026quot;y\u0026quot;:253,\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;lineTo\u0026quot;,\u0026quot;x\u0026quot;:196,\u0026quot;y\u0026quot;:253,\u0026quot;pid\u0026quot;:19}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003cstrong\u003eAfter\u003c/strong\u003e\u003cbr\u003e2 WebSocket messages: (50 ms apart)\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e{\u0026quot;type\u0026quot;:\u0026quot;trace\u0026quot;,\u0026quot;points\u0026quot;:[{\u0026quot;x\u0026quot;:181,\u0026quot;y\u0026quot;:259},{\u0026quot;x\u0026quot;:183,\u0026quot;y\u0026quot;:259},{\u0026quot;x\u0026quot;:184,\u0026quot;y\u0026quot;:257},{\u0026quot;x\u0026quot;:187,\u0026quot;y\u0026quot;:257},{\u0026quot;x\u0026quot;:188,\u0026quot;y\u0026quot;:257},{\u0026quot;x\u0026quot;:191,\u0026quot;y\u0026quot;:256},{\u0026quot;x\u0026quot;:192,\u0026quot;y\u0026quot;:255}],\u0026quot;pid\u0026quot;:19}\n{\u0026quot;type\u0026quot;:\u0026quot;trace\u0026quot;,\u0026quot;points\u0026quot;:[{\u0026quot;x\u0026quot;:192,\u0026quot;y\u0026quot;:255},{\u0026quot;x\u0026quot;:192,\u0026quot;y\u0026quot;:254},{\u0026quot;x\u0026quot;:193,\u0026quot;y\u0026quot;:254},{\u0026quot;x\u0026quot;:195,\u0026quot;y\u0026quot;:254},{\u0026quot;x\u0026quot;:195,\u0026quot;y\u0026quot;:253},{\u0026quot;x\u0026quot;:196,\u0026quot;y\u0026quot;:253},{\u0026quot;x\u0026quot;:196,\u0026quot;y\u0026quot;:253}],\u0026quot;pid\u0026quot;:19}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"to-a-variable-frame-rate\"\u003eTo a variable frame rate?\u003c/h3\u003e\n\u003cp\u003eI am also thinking about a variable rate depending of the number of active painters. In fact, the more we have painters, the more we will have messages, and the more the server will have system interrupts, we could then decrease the frame rate per second to reduce this load.\u003c/p\u003e\n\u003cp\u003eThe problem of this extreme approach is the degradation of the feeling of real-time.\u003c/p\u003e\n\u003cp\u003eFor now, I’m keeping the constant frame rate version, we will see how far it goes.\u003c/p\u003e\n\u003ch2 id=\"storing-painters-information\"\u003eStoring painters information\u003c/h2\u003e\n\u003cp\u003eAs I said, \u003cstrong\u003ea lot of informations was repeated in WebSocket messages.\u003c/strong\u003e In every draw events, painter name, brush size and brush color was sent from the client to the server, and the spread into all connected clients.\u003c/p\u003e\n\u003cp\u003eThis was ok for prototyping but we have now optimize this by storing these painter generic informations in the server and sending them when a new WebSocket connection is opened.\u003c/p\u003e\n\u003ch3 id=\"example-1\"\u003eExample\u003c/h3\u003e\n\u003cp\u003eThis is what a client can receive when a websocket is connected:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e{\u0026quot;type\u0026quot;:\u0026quot;youAre\u0026quot;,\u0026quot;pid\u0026quot;:24}\n{\u0026quot;name\u0026quot;:\u0026quot;john\u0026quot;,\u0026quot;color\u0026quot;:\u0026quot;red\u0026quot;,\u0026quot;size\u0026quot;:5,\u0026quot;type\u0026quot;:\u0026quot;painter\u0026quot;,\u0026quot;pid\u0026quot;:21}\n{\u0026quot;name\u0026quot;:\u0026quot;gre\u0026quot;,\u0026quot;color\u0026quot;:\u0026quot;red\u0026quot;,\u0026quot;size\u0026quot;:5,\u0026quot;type\u0026quot;:\u0026quot;painter\u0026quot;,\u0026quot;pid\u0026quot;:24}\n{\u0026quot;name\u0026quot;:\u0026quot;peter\u0026quot;,\u0026quot;color\u0026quot;:\u0026quot;red\u0026quot;,\u0026quot;size\u0026quot;:5,\u0026quot;type\u0026quot;:\u0026quot;painter\u0026quot;,\u0026quot;pid\u0026quot;:4}\n{\u0026quot;name\u0026quot;:\u0026quot;paul\u0026quot;,\u0026quot;color\u0026quot;:\u0026quot;red\u0026quot;,\u0026quot;size\u0026quot;:5,\u0026quot;type\u0026quot;:\u0026quot;painter\u0026quot;,\u0026quot;pid\u0026quot;:6}\n{\u0026quot;name\u0026quot;:\u0026quot;jack\u0026quot;,\u0026quot;color\u0026quot;:\u0026quot;red\u0026quot;,\u0026quot;size\u0026quot;:5,\u0026quot;type\u0026quot;:\u0026quot;painter\u0026quot;,\u0026quot;pid\u0026quot;:2}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eand then…\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e{\u0026quot;type\u0026quot;:\u0026quot;trace\u0026quot;,\u0026quot;points\u0026quot;:[{\u0026quot;x\u0026quot;:181,\u0026quot;y\u0026quot;:259},{\u0026quot;x\u0026quot;:183,\u0026quot;y\u0026quot;:259},{\u0026quot;x\u0026quot;:184,\u0026quot;y\u0026quot;:257}],\u0026quot;pid\u0026quot;:19}\n...\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBy knowing all painter properties, when someone will draw something, he will not have to repeat which color and size its brush has.\u003c/p\u003e\n\u003ch3 id=\"server-side\"\u003eServer side\u003c/h3\u003e\n\u003cp\u003eIt was quite interesting to implement the server part with \u003ca href=\"https://github.com/playframework/Play20/wiki/Iteratees\"\u003ePlay2′s Iteratees\u003c/a\u003e, a new way of handling I/O – not so new in fact because it is directly related to Haskell Iteratee concepts.\u003c/p\u003e\n\u003cp\u003eTo implement a WebSocket connection, you will provide an \u003cstrong\u003eIteratee\u003c/strong\u003e for consuming the \u003cstrong\u003einput\u003c/strong\u003e and an \u003cstrong\u003eEnumerator\u003c/strong\u003e for producing the \u003cstrong\u003eoutput\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eEnumerator are chainable, this is how I firstly send the painter id and painters informations:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-scala\"\u003e// out: handle messages to send to the painter\nval out =\n  // Inform the painter who he is (which pid, he can them identify himself)\n  Enumerator(JsObject(Seq(\u0026quot;type\u0026quot; -\u0026gt; JsString(\u0026quot;youAre\u0026quot;), \u0026quot;pid\u0026quot; -\u0026gt; JsNumber(pid))).as[JsValue]) \u0026gt;\u0026gt;\u0026gt;\n  // Inform the list of other painters\n  Enumerator(painters.map { case (id, painter) =\u0026gt;\n    (painter.toJson JsObject(Seq(\u0026quot;type\u0026quot; -\u0026gt; JsString(\u0026quot;painter\u0026quot;), \u0026quot;pid\u0026quot; -\u0026gt; JsNumber(id)))).as[JsValue]\n  } toList : _*) \u0026gt;\u0026gt;\u0026gt;\n  // Stream the hub\n  hub.getPatchCord()\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe \u003cstrong\u003e\u0026gt;\u0026gt;\u0026gt;\u003c/strong\u003e operator is a shortcut to the \u003cstrong\u003eandThen\u003c/strong\u003e method which is the way to chain enumerators.\u003c/p\u003e\n\u003cp\u003eFor more details, \u003ca href=\"https://github.com/gre/playpainter/blob/master/scala/app/controllers/Application.scala\"\u003esee the scala code of the controller\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"other-features\"\u003eOther features\u003c/h2\u003e\n\u003cp\u003eThe application has been improved in many other ways.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eA “buffering” Canvas\u003c/strong\u003e in the foreground has been add \u003cstrong\u003efor the user draws\u003c/strong\u003e. It brings client-side reactivity and helps to avoid unpleasant lag feeling when drawing. When the user draw events are coming from the server and no other user events has been sent since, it’s synchronized and we can clean this buffer.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePainter positions are show with their names\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003eIt should now work properly on \u003cstrong\u003esmartphones and tablets\u003c/strong\u003e. Try on iPad and iPhone, and maybe on recent version of Android (WebSocket support required).\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eKeyboard shortcut\u003c/strong\u003e: using arrows to change brush size and color.\u003c/li\u003e\n\u003cli\u003eThe \u003cstrong\u003e\u003ca href=\"http://github.com/gre/playpainter\"\u003esource code\u003c/a\u003e has been polished and commented\u003c/strong\u003e especially the server side part (it’s probably the hardest part if you don’t know Play framework).\u003c/li\u003e\n\u003cli\u003eError message displayed when a technology is not supported and when the WebSocket connection goes down (with a reconnecting try loop).\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"the-demo-is-still-online\"\u003eThe demo is still online!\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ca href=\"http://playpainter.greweb.fr/\"\u003eplaypainter.greweb.fr\u003c/a\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003ch2 id=\"future\"\u003eFuture\u003c/h2\u003e\n\u003cp\u003eWith these two optimizations, I’ve reduce the global \u003cstrong\u003enumber of socket messages\u003c/strong\u003e and also the \u003cstrong\u003esize of each message\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThe first benchmark sounds good, 3 painters was simultaneously crazily painting while the server application was only using less than 10% of CPU.\u003c/p\u003e\n\u003cp\u003eNow, the most challenging part would be to scale the application to a huge number of connections, but having maybe solved this bottleneck, it’s maybe now more a matter of system architecture than the application itself.\u003c/p\u003e\n\u003cp\u003eThis experiment gave me a lot of interest in \u003cstrong\u003eWebSocket\u003c/strong\u003e and also in \u003cstrong\u003ethe powerful way WebSockets are handled in Play framework\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eIf anyone want to start a Java version of the application, please go on! \u003ca href=\"https://github.com/gre/playpainter/issues/1\"\u003e(this was requested on Github)\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThanks to \u003ca href=\"https://twitter.com/dbathily\"\u003e@dbathily\u003c/a\u003e, we know have both Scala and Java version!\u003c/p\u003e\n\u003ch3 id=\"next-experiment\"\u003eNext experiment\u003c/h3\u003e\n\u003cp\u003eI am thinking about making a multiplayer game on the web.\u003cbr\u003eIt would be something like a shooter survival game (like Counter Strike Zombie Mod) a multi-plateform 2D side view game (like Mario) !\u003c/p\u003e\n\u003cp\u003eYou will know more about this soon!\u003c/p\u003e\n","data":{"title":"Play Painter – how i've improved the 30 minutes prototyped version","description":"One week ago, I’ve released a web experiment featuring a collaborative Paint-like application made with Play Framework 2 and relying on WebSocket and HTML5 Canvas. Here is how I've improved it.","thumbnail":"/images/2012/03/twitt_playpainter.png","author":"Gaetan","layout":"post","permalink":"/2012/03/play-painter-how-ive-improved-the-30-minutes-prototyped-version/","tags":["canvas","playframework","websocket","javascript"]}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2012","month":"03","slug":"play-painter-how-ive-improved-the-30-minutes-prototyped-version"},"buildId":"U2t60rVT7QXGvI-bQnIso","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
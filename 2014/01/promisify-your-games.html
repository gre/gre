<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="author" content="GaÃ«tan Renaudeau"/><meta name="description" content="a game showcase using Q Promise as first-class citizen and driven with CSS3 Animations via Zanimo."/><meta name="keywords" content="gamedev, promise, Q, ludumdare"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@greweb"/><meta name="twitter:title" content="Promisify your games"/><meta name="og:title" content="Promisify your games"/><meta name="twitter:description" content="a game showcase using Q Promise as first-class citizen and driven with CSS3 Animations via Zanimo."/><meta name="twitter:creator" content="@greweb"/><meta name="og:image" content="http://greweb.me//images/2014/01/ld28.png"/><meta name="twitter:image" content="http://greweb.me//images/2014/01/ld28.png"/><link rel="image_src" href="http://greweb.me//images/2014/01/ld28.png"/><title>@greweb - Promisify your games</title><link href="http://fonts.googleapis.com/css?family=Fredericka+the+Great|Arapey|Roboto:400,700,400italic" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/styles/default.min.css"/><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/highlight.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/javascript.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/cpp.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/glsl.min.js"></script><link rel="stylesheet" href="/style/main.css"/><meta name="next-head-count" content="25"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-381dbb3c33243b4920e6.js"></script><script src="/_next/static/chunks/webpack-17597d20e291f72b2439.js" defer=""></script><script src="/_next/static/chunks/framework-bdc1b4e5e48979e16d36.js" defer=""></script><script src="/_next/static/chunks/main-4ac108dd57980e4159e9.js" defer=""></script><script src="/_next/static/chunks/pages/_app-c981e0e3ce59f13eb8d0.js" defer=""></script><script src="/_next/static/chunks/5988-738c1ea5f97353b6463e.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-b78f23c90ce5148ef413.js" defer=""></script><script src="/_next/static/781C19nlBbcANu0J9GVGO/_buildManifest.js" defer=""></script><script src="/_next/static/781C19nlBbcANu0J9GVGO/_ssgManifest.js" defer=""></script><style id="__jsx-2519965637">.block.jsx-2519965637{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.block.jsx-2519965637 .right.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637{margin-top:10px;}.block.jsx-2519965637 .social.jsx-2519965637 a.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637 img.jsx-2519965637{height:20px;}</style><style id="__jsx-3621368397">.container.jsx-3621368397{min-height:100vh;padding:0 0.5rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style id="__jsx-3469673304">html,body{padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}*{box-sizing:border-box;}a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}a:hover,a:active{-webkit-text-decoration:underline;text-decoration:underline;}</style></head><body><div id="__next"><div class="jsx-3621368397 container"><div id="container"><div id="main"><div id="content"><article><header><h1><a href="/">Promisify your games</a></h1><time class="date" dateTime="2014-01-12">2014-01-12</time><span class="tags"><a class="tag">gamedev</a><a class="tag">promise</a><a class="tag">Q</a><a class="tag">ludumdare</a></span></header><div class="entry-content"><p>One month ago was the <a href="http://www.ludumdare.com/compo/">LudumDare</a> #28 gamejam theming <em>&quot;You Only Get One&quot;</em>.</p>
<a href="http://greweb.me/ld28/">
  <img src="/images/2014/01/ld28.png" alt="" class="thumbnail-left" />
</a>

<p>I <a href="http://www.ludumdare.com/compo/ludum-dare-28/?action=preview&amp;uid=18803">submitted</a> a <a href="http://greweb.me/ld28/">mini-game</a> which ranked 105th out of 2064 entries and also 26th in the &quot;theme&quot; category.</p>
<p>This is of-course a web game implemented in JavaScript and using HTML and CSS.</p>
<p>But actually, my main goal was not really making a game done 
but more about technically <strong>making a state-of-the-art Promise-based game</strong>.</p>
<p>I think <a href="/2013/07/q-a-promise-library/">Promises</a> contains very interesting advantages in a game development design:
<em>Resource loading managment</em>, <em>game scenes chaining</em>, <em>animations</em>... are some use-cases.</p>
<ul>
<li>Checkout the <a href="https://github.com/gre/ld28">source code</a> on Github - <a href="https://github.com/gre/ld28/tree/master/src/app.js"><code>src/app.js</code></a> is the entry point</li>
<li>LudumDare entry is <a href="http://www.ludumdare.com/compo/ludum-dare-28/?action=preview&amp;uid=18803">here</a>.</li>
<li><a href="http://greweb.me/ld28/">Play the Game</a>.</li>
</ul>
<!--more-->

<h2 id="fp-in-game-development">FP in game development</h2>
<p>Using some Functional Programming paradigm in game development is interesting,
and here I&#39;m just talking at least about the basic stuff:
<strong>Avoid globals, Minimize state variables</strong>.</p>
<p>I&#39;ve written a few games where restarting the game without using <code>location.reload()</code> was a challenge
because the game variable states was so spread everywhere!</p>
<p>By doing more FP, you can have this restart feature by design without need to &quot;reset&quot; all variables
because your start function just takes everything it needs in parameter and restarting is just about re-calling that function.</p>
<h2 id="promises-as-first-class-citizen">Promises as first-class citizen</h2>
<h3 id="game-scenes-chaining">Game scenes chaining</h3>
<p>Like maybe 99% of games, my game has an <strong>intro</strong> (menu), a <strong>main</strong> scene and an <strong>outro</strong> scene (gameover / finish).</p>
<p>When you develop a game with just one big <code>render()</code> loop,
it easily becomes a pain when you want to add more steps to the scene,
it doesn&#39;t scale and fastly become spaghetti code:
you tend to have to figure out in which state you are (or which part of the animation timeline) from the game state.</p>
<p>Hopefully, scene management is very easy to do with Promises:</p>
<pre><code class="language-javascript">function start () {
  return Q()
    .then(intro)
    .then(_.partial(runMiniGames, 20))
    .then(outro);
}

Q.all([/*..something to load..*/])
 .then(start/*, ..*/) // start game when ready
 .done(); // just help Q to trigger errors if some.
</code></pre>
<p>How beautiful to read! Call <code>intro</code> then run 20 mini-games then perform <code>outro</code>.</p>
<h4 id="no-game-state-shared-pure-functions">No game state shared, pure functions</h4>
<p><strong>intro</strong> is the menu screen where you can choose the game difficulty.
<strong>outro</strong> is the game end screen where the final score is displayed.
There is however <strong>no global variables shared</strong>, those are just passed from one function to another.</p>
<p>Let&#39;s look deeper in how it works:</p>
<ul>
<li>The <code>intro()</code> function just returns a Promise resolved when the user made a &quot;difficulty&quot; choice. That Promise actually contains the difficulty (0, 1 or 2).</li>
<li>The <code>runMiniGames</code> function takes 2 parameters: the number of games and the difficulty. <code>_.partial(runMiniGames, 20)</code> is just an helper for making a 20 mini-games function which takes the difficulty in parameter. This difficulty is given by the previous Promise. The <code>runMiniGames</code> function returns a Promise of Score (integer).</li>
<li>That score is then fed into the <code>outro(score)</code> function which displays this score to the user.</li>
</ul>
<blockquote>
<p><strong>TL;DR.</strong> This is just about plumbing 3 functions together!</p>
</blockquote>
<p>Checkout also the <a href="https://github.com/gre/ld28/blob/master/src/app.js#L24-L37"><code>runMiniGames</code> implementation</a>.</p>
<h4 id="speed-up-the-development">Speed up the development</h4>
<p>And you know what? It make development easier and faster because you can easily skip some part in any Promises chain:</p>
<pre><code class="language-javascript">function start () {
  return Q(0)
    //.then(intro) // Directly jump to the games
    .then(_.partial(runMiniGames, 20))
    .then(outro);
}
</code></pre>
<p>I used that a lot and not only for this part, but for all part during the game development.</p>
<h3 id="loading-resources">Loading resources</h3>
<p>Promises also help you to wait resources before starting the game.
You don&#39;t have to make yet another loading library, Promise already are ready for that, 
and you can also have proper error managment or even &quot;progress&quot; loading display (Q has Progress event in a Promise).</p>
<p>Each loading resource is a Promise and you can combine them all using <code>Q.all</code>.</p>
<p>Here is an example using <a href="https://npmjs.org/package/qajax">Qajax</a> and <a href="https://npmjs.org/package/qimage">Qimage</a>.</p>
<pre><code class="language-javascript">Q.all([
  Qajax(&quot;music.wav&quot;).then(mapToAudio),
  Qajax.getJSON(&quot;map.json&quot;),
  Qimage(&quot;images/logo.png&quot;),
  Qimage(&quot;images/textures.png&quot;)
]).spread(function (music, map, logo, textures) {
  
  // Start the game !

}, function (error) {

  // display proper error

}, function (progressEvent) {

  // maybe you want to display a loading progress bar 
  // with that third progress callback.

});
</code></pre>
<p>Here is a similar example:</p>
<pre><code class="language-javascript">var musicPromise = Qajax(&quot;music.wav&quot;).then(mapToAudio);
var mapPromise = Qajax.getJSON(&quot;map.json&quot;);
var texturesPromise = Qimage(&quot;images/textures.png&quot;);
Q.all([ mapPromise, texturesPromise ]).spread(startGame, errorLoading);
// because maybe you don&#39;t want to wait the music for starting the game:
musicPromise.then(function (a) { a.play(); });

function startGame (map, textures) {
  // ...
}
function errorLoading (e) {
  // ...
}
</code></pre>
<h3 id="mini-games-workflow">Mini games workflow</h3>
<p>My games is divided into a set of mini-games which are all independent but share a common interface.
This interface was quite a WIP at the end of the weekend development but it does the job.</p>
<p>Here is the template I used for my game: <a href="https://github.com/gre/ld28/blob/master/src/games/_template.js">src/games/_template.js</a>.</p>
<p>A Game instance has different methods, and especially <code>enter</code> and <code>leave</code> method which are call on game enter and on game leave. It also has a <code>.end</code> Promise which is resolved when the Game end.</p>
<ul>
<li>A mini-game when solved gives a score depending on how well the user succeed it (through the <code>end</code> Promise).</li>
<li>A mini-game have a timeout and if the player doesn&#39;t terminate it, it passes to the next game without scores.</li>
</ul>
<p>Those <code>enter()</code> and <code>leave()</code> methods return Promise in order to be plugged in the game workflow (we can wait them to finish before moving to next state).</p>
<p>For instance, we don&#39;t start the game timeout before it actually starts (just wait the <code>enter()</code> Promise to be resolved) and also we don&#39;t switch to the next game before the <code>leave()</code> Promise is done).</p>
<p>Checkout also the <a href="https://github.com/gre/ld28/blob/master/src/app.js#L51-L76"><code>nextMiniGame</code> implementation</a>.
The result of that function is the score of the mini-game and that we sum up all scores from the previous score.</p>
<h4 id="composability">Composability</h4>
<p>The <code>enter()</code> and <code>leave()</code> methods can be composed of animations which can themselves be composed of animations.</p>
<p><strong>We can easily subdivided work into different level of Promises chain.</strong>
Here is a little schema to summary that composability:</p>
<p><img src="/images/2014/01/ld28_composition_schema.svg" alt=""></p>
<h3 id="promise-animations">Promise Animations</h3>
<p>In my game, all the animations are controlled with Promises more exactly using CSS3 Transitions 
via <strong><a href="https://github.com/peutetre/Zanimo">Zanimo</a> Promise library</strong> because it fits my game (DOM-based game).
The fact that a Promise can be waited and chained <strong>gives a powerful controls over CSS Transitions for making animations</strong>.</p>
<p>You can easily trigger animations <strong>one after another</strong> for moving an element in multiple places.
You can also perform <strong>multiple animations at the same times</strong> (on 2 different elements) and <strong>wait for both to finish</strong>
before triggering a third animation.</p>
<p>See for instance how <code>enter()</code> and <code>leave()</code> animations are done in mini-games.</p>
<p>In the animation ending the &quot;memo&quot; game I used concurrent animations:
all memo cards are randomly moved out.</p>
<pre><code class="language-javascript">/* // FYI
Card.prototype.transform = function (x, y, scale, duration) {
  return Zanimo.transition(this.el, &quot;transform&quot;,
    &quot;translate(&quot;+x+&quot;px, &quot;+y+&quot;px) scale(&quot;+scale+&quot;)&quot;, duration||0);
};
*/

function animateOut (dispersion) {
  return Q.all(_.map(cards, function (card) {
    if (card.destroyed) return Q(); // no animation because card is destroyed
    return Q()
      .then(function(){
        return card.transform(card.x, card.y, card.number === 1 ? 1 : 0.8, 100);
      })
      .delay(Math.floor((card.number===1 ? 500 : 0)+300*Math.random()))
      .then(function () {
        var x = Math.round((Math.random()&lt;0.5 ? -card.w/dimensions.width-dispersion*Math.random() : 1+dispersion*Math.random())*dimensions.width);
        var y = Math.round((Math.random()&lt;0.5 ? -card.h/dimensions.height-dispersion*Math.random() : 1+dispersion*Math.random())*dimensions.height);
        return card.transform(x, y, 0, 500);
      });
  }));
}

// Usage in Memo.leave() :
return Q.delay(50)
  .then(function(){ return animateOut(0.5); })
  .delay(100);
</code></pre>
<p>In the calculation game I used a chain of animations subdivided in functions:</p>
<pre><code class="language-javascript">return Q.delay(50)
  .then(fadeOutInvalids)
  .then(displaySolution)
  .then(displayEquality)
  .delay(500)
  .then(fadeOut)
  .then(hideEquality)
  .delay(200);
</code></pre>
<p><a href="https://github.com/gre/ld28/blob/master/src/games/calculation.js#L411-L500">Full code here</a>.</p>
<h3 id="wait-for-next-click">&quot;Wait for next click&quot;</h3>
<p>While my game are just based on click user interaction,
I&#39;ve made a <a href="https://github.com/gre/ld28/blob/master/src/waitNextClick.js"><code>waitNextClick</code></a> function
which returns a Promise of click for the given element.</p>
<pre><code class="language-javascript">var Q = require(&quot;q&quot;);

module.exports = function waitNextClick (btn) {
  var d = Q.defer();
  btn.addEventListener(&quot;click&quot;, function listener (e) {
    btn.removeEventListener(&quot;click&quot;, listener);
    d.resolve(e.target);
  }, false);
  return d.promise;
};
</code></pre>
<p>This was quite an interesting solution which is just like a jQuery &quot;once&quot; event but in Promise paradigm.</p>
<p>I was able to combine that function with <code>Q.race</code> which wait for one of the given Promise to be redeemed.</p>
<blockquote>
<p><code>Q.race(_.map(btns, waitNextClick))</code></p>
</blockquote>
<p>For instance in the cats game, I just wait the first &quot;This one&quot; button to be clicked:</p>
<pre><code class="language-javascript">var houseChoice = Q.race(_.map(this.houses, function (catHouse) {
    return waitNextClick(catHouse.btn)
    .then(function () {
      return catHouse;
    });
// houseChoice is a Promise of House choosen by the player.
</code></pre>
<h3 id="using-the-progress-event">Using the &quot;progress&quot; event</h3>
<p>I also used a bit the &quot;progress&quot; event of a Q Promise, which is a way to notify that a Promise is being resolved.</p>
<ul>
<li>I used that &quot;progress&quot; event on the <code>game.end</code> Promise for notifying that the player is winning some scores in a mini-game while playing.</li>
<li>I also used it to make a timeout ticking the remaining time before the timeout is reached and that Promise resolved.</li>
</ul>
<p>See both usages <a href="https://github.com/gre/ld28/blob/master/src/app.js#L62-L70">here</a>:</p>
<pre><code class="language-javascript">return Q.race([
  gameEnd
    .progress(function (score) {
      stats.setScore(totalScore+score);
    }),
  timeoutWithTicks(gameEnd, timeout)
    .progress(stats.setTimeProgress)
    .then(_.bind(game.submit, game))
]);
</code></pre>
<h2 id="code-organization-using-npm--browserify">Code organization using NPM + Browserify</h2>
<p>NPM &amp; Browserify has also been used because I find this stack very productive,
especially when writing a game from scratch.</p>
<p>Browserify has been trendy the last past year, but there is here an interesting way of organizing your code
and especially reusing it.
You can find a lot of <a href="https://npmjs.org/">available modules using NPM</a>, 
Browserify will just make you able to require them using <code>require(&quot;modulename&quot;)</code>.</p>
</div><footer><div class="jsx-2519965637 block"><img src="http://greweb.me/logo.svg" width="100" class="jsx-2519965637"/><div class="jsx-2519965637 right"><div class="jsx-2519965637 description">generative artist. doodling with algorithms (creative coding). shaders &amp; fountain pens robot plotting.</div><div class="jsx-2519965637 social"><a href="https://twitter.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitter.svg" class="jsx-2519965637"/></a><a href="https://instagram.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/instagram.svg" class="jsx-2519965637"/></a><a href="https://twitch.tv/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitch.svg" class="jsx-2519965637"/></a><a href="https://github.com/gre" class="jsx-2519965637"><img alt="" src="/icons/github.svg" class="jsx-2519965637"/></a><a href="https://opensea.io/greweb" class="jsx-2519965637"><img alt="" src="/icons/eth.svg" class="jsx-2519965637"/></a><a href="https://objkt.com/profile/tz1cgQAQfECg5bPASYTMyJ9QJQjSUi8rfL67" class="jsx-2519965637"><img alt="" src="/icons/tz.svg" class="jsx-2519965637"/></a><a href="https://fxhash.xyz/u/greweb" class="jsx-2519965637"><img alt="" src="/icons/tz.svg" class="jsx-2519965637"/></a><a href="https://greweb.itch.io" class="jsx-2519965637"><img alt="" src="/icons/iconmonstr-gamepad-3.svg" class="jsx-2519965637"/></a></div></div></div></footer></article></div></div></div><script>hljs.highlightAll();</script></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"2014-01-12-promisify-your-games","year":"2014","month":"01","day":"12","slug":"promisify-your-games","content":"\u003cp\u003eOne month ago was the \u003ca href=\"http://www.ludumdare.com/compo/\"\u003eLudumDare\u003c/a\u003e #28 gamejam theming \u003cem\u003e\u0026quot;You Only Get One\u0026quot;\u003c/em\u003e.\u003c/p\u003e\n\u003ca href=\"http://greweb.me/ld28/\"\u003e\n  \u003cimg src=\"/images/2014/01/ld28.png\" alt=\"\" class=\"thumbnail-left\" /\u003e\n\u003c/a\u003e\n\n\u003cp\u003eI \u003ca href=\"http://www.ludumdare.com/compo/ludum-dare-28/?action=preview\u0026amp;uid=18803\"\u003esubmitted\u003c/a\u003e a \u003ca href=\"http://greweb.me/ld28/\"\u003emini-game\u003c/a\u003e which ranked 105th out of 2064 entries and also 26th in the \u0026quot;theme\u0026quot; category.\u003c/p\u003e\n\u003cp\u003eThis is of-course a web game implemented in JavaScript and using HTML and CSS.\u003c/p\u003e\n\u003cp\u003eBut actually, my main goal was not really making a game done \nbut more about technically \u003cstrong\u003emaking a state-of-the-art Promise-based game\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eI think \u003ca href=\"/2013/07/q-a-promise-library/\"\u003ePromises\u003c/a\u003e contains very interesting advantages in a game development design:\n\u003cem\u003eResource loading managment\u003c/em\u003e, \u003cem\u003egame scenes chaining\u003c/em\u003e, \u003cem\u003eanimations\u003c/em\u003e... are some use-cases.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCheckout the \u003ca href=\"https://github.com/gre/ld28\"\u003esource code\u003c/a\u003e on Github - \u003ca href=\"https://github.com/gre/ld28/tree/master/src/app.js\"\u003e\u003ccode\u003esrc/app.js\u003c/code\u003e\u003c/a\u003e is the entry point\u003c/li\u003e\n\u003cli\u003eLudumDare entry is \u003ca href=\"http://www.ludumdare.com/compo/ludum-dare-28/?action=preview\u0026amp;uid=18803\"\u003ehere\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://greweb.me/ld28/\"\u003ePlay the Game\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!--more--\u003e\n\n\u003ch2 id=\"fp-in-game-development\"\u003eFP in game development\u003c/h2\u003e\n\u003cp\u003eUsing some Functional Programming paradigm in game development is interesting,\nand here I\u0026#39;m just talking at least about the basic stuff:\n\u003cstrong\u003eAvoid globals, Minimize state variables\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eI\u0026#39;ve written a few games where restarting the game without using \u003ccode\u003elocation.reload()\u003c/code\u003e was a challenge\nbecause the game variable states was so spread everywhere!\u003c/p\u003e\n\u003cp\u003eBy doing more FP, you can have this restart feature by design without need to \u0026quot;reset\u0026quot; all variables\nbecause your start function just takes everything it needs in parameter and restarting is just about re-calling that function.\u003c/p\u003e\n\u003ch2 id=\"promises-as-first-class-citizen\"\u003ePromises as first-class citizen\u003c/h2\u003e\n\u003ch3 id=\"game-scenes-chaining\"\u003eGame scenes chaining\u003c/h3\u003e\n\u003cp\u003eLike maybe 99% of games, my game has an \u003cstrong\u003eintro\u003c/strong\u003e (menu), a \u003cstrong\u003emain\u003c/strong\u003e scene and an \u003cstrong\u003eoutro\u003c/strong\u003e scene (gameover / finish).\u003c/p\u003e\n\u003cp\u003eWhen you develop a game with just one big \u003ccode\u003erender()\u003c/code\u003e loop,\nit easily becomes a pain when you want to add more steps to the scene,\nit doesn\u0026#39;t scale and fastly become spaghetti code:\nyou tend to have to figure out in which state you are (or which part of the animation timeline) from the game state.\u003c/p\u003e\n\u003cp\u003eHopefully, scene management is very easy to do with Promises:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003efunction start () {\n  return Q()\n    .then(intro)\n    .then(_.partial(runMiniGames, 20))\n    .then(outro);\n}\n\nQ.all([/*..something to load..*/])\n .then(start/*, ..*/) // start game when ready\n .done(); // just help Q to trigger errors if some.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHow beautiful to read! Call \u003ccode\u003eintro\u003c/code\u003e then run 20 mini-games then perform \u003ccode\u003eoutro\u003c/code\u003e.\u003c/p\u003e\n\u003ch4 id=\"no-game-state-shared-pure-functions\"\u003eNo game state shared, pure functions\u003c/h4\u003e\n\u003cp\u003e\u003cstrong\u003eintro\u003c/strong\u003e is the menu screen where you can choose the game difficulty.\n\u003cstrong\u003eoutro\u003c/strong\u003e is the game end screen where the final score is displayed.\nThere is however \u003cstrong\u003eno global variables shared\u003c/strong\u003e, those are just passed from one function to another.\u003c/p\u003e\n\u003cp\u003eLet\u0026#39;s look deeper in how it works:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe \u003ccode\u003eintro()\u003c/code\u003e function just returns a Promise resolved when the user made a \u0026quot;difficulty\u0026quot; choice. That Promise actually contains the difficulty (0, 1 or 2).\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003erunMiniGames\u003c/code\u003e function takes 2 parameters: the number of games and the difficulty. \u003ccode\u003e_.partial(runMiniGames, 20)\u003c/code\u003e is just an helper for making a 20 mini-games function which takes the difficulty in parameter. This difficulty is given by the previous Promise. The \u003ccode\u003erunMiniGames\u003c/code\u003e function returns a Promise of Score (integer).\u003c/li\u003e\n\u003cli\u003eThat score is then fed into the \u003ccode\u003eoutro(score)\u003c/code\u003e function which displays this score to the user.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eTL;DR.\u003c/strong\u003e This is just about plumbing 3 functions together!\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eCheckout also the \u003ca href=\"https://github.com/gre/ld28/blob/master/src/app.js#L24-L37\"\u003e\u003ccode\u003erunMiniGames\u003c/code\u003e implementation\u003c/a\u003e.\u003c/p\u003e\n\u003ch4 id=\"speed-up-the-development\"\u003eSpeed up the development\u003c/h4\u003e\n\u003cp\u003eAnd you know what? It make development easier and faster because you can easily skip some part in any Promises chain:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003efunction start () {\n  return Q(0)\n    //.then(intro) // Directly jump to the games\n    .then(_.partial(runMiniGames, 20))\n    .then(outro);\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI used that a lot and not only for this part, but for all part during the game development.\u003c/p\u003e\n\u003ch3 id=\"loading-resources\"\u003eLoading resources\u003c/h3\u003e\n\u003cp\u003ePromises also help you to wait resources before starting the game.\nYou don\u0026#39;t have to make yet another loading library, Promise already are ready for that, \nand you can also have proper error managment or even \u0026quot;progress\u0026quot; loading display (Q has Progress event in a Promise).\u003c/p\u003e\n\u003cp\u003eEach loading resource is a Promise and you can combine them all using \u003ccode\u003eQ.all\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHere is an example using \u003ca href=\"https://npmjs.org/package/qajax\"\u003eQajax\u003c/a\u003e and \u003ca href=\"https://npmjs.org/package/qimage\"\u003eQimage\u003c/a\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eQ.all([\n  Qajax(\u0026quot;music.wav\u0026quot;).then(mapToAudio),\n  Qajax.getJSON(\u0026quot;map.json\u0026quot;),\n  Qimage(\u0026quot;images/logo.png\u0026quot;),\n  Qimage(\u0026quot;images/textures.png\u0026quot;)\n]).spread(function (music, map, logo, textures) {\n  \n  // Start the game !\n\n}, function (error) {\n\n  // display proper error\n\n}, function (progressEvent) {\n\n  // maybe you want to display a loading progress bar \n  // with that third progress callback.\n\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eHere is a similar example:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar musicPromise = Qajax(\u0026quot;music.wav\u0026quot;).then(mapToAudio);\nvar mapPromise = Qajax.getJSON(\u0026quot;map.json\u0026quot;);\nvar texturesPromise = Qimage(\u0026quot;images/textures.png\u0026quot;);\nQ.all([ mapPromise, texturesPromise ]).spread(startGame, errorLoading);\n// because maybe you don\u0026#39;t want to wait the music for starting the game:\nmusicPromise.then(function (a) { a.play(); });\n\nfunction startGame (map, textures) {\n  // ...\n}\nfunction errorLoading (e) {\n  // ...\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"mini-games-workflow\"\u003eMini games workflow\u003c/h3\u003e\n\u003cp\u003eMy games is divided into a set of mini-games which are all independent but share a common interface.\nThis interface was quite a WIP at the end of the weekend development but it does the job.\u003c/p\u003e\n\u003cp\u003eHere is the template I used for my game: \u003ca href=\"https://github.com/gre/ld28/blob/master/src/games/_template.js\"\u003esrc/games/_template.js\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eA Game instance has different methods, and especially \u003ccode\u003eenter\u003c/code\u003e and \u003ccode\u003eleave\u003c/code\u003e method which are call on game enter and on game leave. It also has a \u003ccode\u003e.end\u003c/code\u003e Promise which is resolved when the Game end.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA mini-game when solved gives a score depending on how well the user succeed it (through the \u003ccode\u003eend\u003c/code\u003e Promise).\u003c/li\u003e\n\u003cli\u003eA mini-game have a timeout and if the player doesn\u0026#39;t terminate it, it passes to the next game without scores.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThose \u003ccode\u003eenter()\u003c/code\u003e and \u003ccode\u003eleave()\u003c/code\u003e methods return Promise in order to be plugged in the game workflow (we can wait them to finish before moving to next state).\u003c/p\u003e\n\u003cp\u003eFor instance, we don\u0026#39;t start the game timeout before it actually starts (just wait the \u003ccode\u003eenter()\u003c/code\u003e Promise to be resolved) and also we don\u0026#39;t switch to the next game before the \u003ccode\u003eleave()\u003c/code\u003e Promise is done).\u003c/p\u003e\n\u003cp\u003eCheckout also the \u003ca href=\"https://github.com/gre/ld28/blob/master/src/app.js#L51-L76\"\u003e\u003ccode\u003enextMiniGame\u003c/code\u003e implementation\u003c/a\u003e.\nThe result of that function is the score of the mini-game and that we sum up all scores from the previous score.\u003c/p\u003e\n\u003ch4 id=\"composability\"\u003eComposability\u003c/h4\u003e\n\u003cp\u003eThe \u003ccode\u003eenter()\u003c/code\u003e and \u003ccode\u003eleave()\u003c/code\u003e methods can be composed of animations which can themselves be composed of animations.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eWe can easily subdivided work into different level of Promises chain.\u003c/strong\u003e\nHere is a little schema to summary that composability:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/images/2014/01/ld28_composition_schema.svg\" alt=\"\"\u003e\u003c/p\u003e\n\u003ch3 id=\"promise-animations\"\u003ePromise Animations\u003c/h3\u003e\n\u003cp\u003eIn my game, all the animations are controlled with Promises more exactly using CSS3 Transitions \nvia \u003cstrong\u003e\u003ca href=\"https://github.com/peutetre/Zanimo\"\u003eZanimo\u003c/a\u003e Promise library\u003c/strong\u003e because it fits my game (DOM-based game).\nThe fact that a Promise can be waited and chained \u003cstrong\u003egives a powerful controls over CSS Transitions for making animations\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eYou can easily trigger animations \u003cstrong\u003eone after another\u003c/strong\u003e for moving an element in multiple places.\nYou can also perform \u003cstrong\u003emultiple animations at the same times\u003c/strong\u003e (on 2 different elements) and \u003cstrong\u003ewait for both to finish\u003c/strong\u003e\nbefore triggering a third animation.\u003c/p\u003e\n\u003cp\u003eSee for instance how \u003ccode\u003eenter()\u003c/code\u003e and \u003ccode\u003eleave()\u003c/code\u003e animations are done in mini-games.\u003c/p\u003e\n\u003cp\u003eIn the animation ending the \u0026quot;memo\u0026quot; game I used concurrent animations:\nall memo cards are randomly moved out.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e/* // FYI\nCard.prototype.transform = function (x, y, scale, duration) {\n  return Zanimo.transition(this.el, \u0026quot;transform\u0026quot;,\n    \u0026quot;translate(\u0026quot;+x+\u0026quot;px, \u0026quot;+y+\u0026quot;px) scale(\u0026quot;+scale+\u0026quot;)\u0026quot;, duration||0);\n};\n*/\n\nfunction animateOut (dispersion) {\n  return Q.all(_.map(cards, function (card) {\n    if (card.destroyed) return Q(); // no animation because card is destroyed\n    return Q()\n      .then(function(){\n        return card.transform(card.x, card.y, card.number === 1 ? 1 : 0.8, 100);\n      })\n      .delay(Math.floor((card.number===1 ? 500 : 0)+300*Math.random()))\n      .then(function () {\n        var x = Math.round((Math.random()\u0026lt;0.5 ? -card.w/dimensions.width-dispersion*Math.random() : 1+dispersion*Math.random())*dimensions.width);\n        var y = Math.round((Math.random()\u0026lt;0.5 ? -card.h/dimensions.height-dispersion*Math.random() : 1+dispersion*Math.random())*dimensions.height);\n        return card.transform(x, y, 0, 500);\n      });\n  }));\n}\n\n// Usage in Memo.leave() :\nreturn Q.delay(50)\n  .then(function(){ return animateOut(0.5); })\n  .delay(100);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the calculation game I used a chain of animations subdivided in functions:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003ereturn Q.delay(50)\n  .then(fadeOutInvalids)\n  .then(displaySolution)\n  .then(displayEquality)\n  .delay(500)\n  .then(fadeOut)\n  .then(hideEquality)\n  .delay(200);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/gre/ld28/blob/master/src/games/calculation.js#L411-L500\"\u003eFull code here\u003c/a\u003e.\u003c/p\u003e\n\u003ch3 id=\"wait-for-next-click\"\u003e\u0026quot;Wait for next click\u0026quot;\u003c/h3\u003e\n\u003cp\u003eWhile my game are just based on click user interaction,\nI\u0026#39;ve made a \u003ca href=\"https://github.com/gre/ld28/blob/master/src/waitNextClick.js\"\u003e\u003ccode\u003ewaitNextClick\u003c/code\u003e\u003c/a\u003e function\nwhich returns a Promise of click for the given element.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar Q = require(\u0026quot;q\u0026quot;);\n\nmodule.exports = function waitNextClick (btn) {\n  var d = Q.defer();\n  btn.addEventListener(\u0026quot;click\u0026quot;, function listener (e) {\n    btn.removeEventListener(\u0026quot;click\u0026quot;, listener);\n    d.resolve(e.target);\n  }, false);\n  return d.promise;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis was quite an interesting solution which is just like a jQuery \u0026quot;once\u0026quot; event but in Promise paradigm.\u003c/p\u003e\n\u003cp\u003eI was able to combine that function with \u003ccode\u003eQ.race\u003c/code\u003e which wait for one of the given Promise to be redeemed.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ccode\u003eQ.race(_.map(btns, waitNextClick))\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFor instance in the cats game, I just wait the first \u0026quot;This one\u0026quot; button to be clicked:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar houseChoice = Q.race(_.map(this.houses, function (catHouse) {\n    return waitNextClick(catHouse.btn)\n    .then(function () {\n      return catHouse;\n    });\n// houseChoice is a Promise of House choosen by the player.\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"using-the-progress-event\"\u003eUsing the \u0026quot;progress\u0026quot; event\u003c/h3\u003e\n\u003cp\u003eI also used a bit the \u0026quot;progress\u0026quot; event of a Q Promise, which is a way to notify that a Promise is being resolved.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eI used that \u0026quot;progress\u0026quot; event on the \u003ccode\u003egame.end\u003c/code\u003e Promise for notifying that the player is winning some scores in a mini-game while playing.\u003c/li\u003e\n\u003cli\u003eI also used it to make a timeout ticking the remaining time before the timeout is reached and that Promise resolved.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSee both usages \u003ca href=\"https://github.com/gre/ld28/blob/master/src/app.js#L62-L70\"\u003ehere\u003c/a\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003ereturn Q.race([\n  gameEnd\n    .progress(function (score) {\n      stats.setScore(totalScore+score);\n    }),\n  timeoutWithTicks(gameEnd, timeout)\n    .progress(stats.setTimeProgress)\n    .then(_.bind(game.submit, game))\n]);\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"code-organization-using-npm--browserify\"\u003eCode organization using NPM + Browserify\u003c/h2\u003e\n\u003cp\u003eNPM \u0026amp; Browserify has also been used because I find this stack very productive,\nespecially when writing a game from scratch.\u003c/p\u003e\n\u003cp\u003eBrowserify has been trendy the last past year, but there is here an interesting way of organizing your code\nand especially reusing it.\nYou can find a lot of \u003ca href=\"https://npmjs.org/\"\u003eavailable modules using NPM\u003c/a\u003e, \nBrowserify will just make you able to require them using \u003ccode\u003erequire(\u0026quot;modulename\u0026quot;)\u003c/code\u003e.\u003c/p\u003e\n","data":{"title":"Promisify your games","description":"a game showcase using Q Promise as first-class citizen and driven with CSS3 Animations via Zanimo.","thumbnail":"/images/2014/01/ld28.png","author":"Gaetan","layout":"post","tags":["gamedev","promise","Q","ludumdare"]}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2014","month":"01","slug":"promisify-your-games"},"buildId":"781C19nlBbcANu0J9GVGO","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
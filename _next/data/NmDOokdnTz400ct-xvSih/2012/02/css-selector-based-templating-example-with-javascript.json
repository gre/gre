{"pageProps":{"id":"2012-02-04-css-selector-based-templating-example-with-javascript","year":"2012","month":"02","day":"04","slug":"css-selector-based-templating-example-with-javascript","content":"<img src=\"/images/2012/02/218px-Mir_diagram-fr.svg_.png\" alt=\"\" class=\"thumbnail-left\" />\n\n<p>In this article, we will focus on the power of <strong>CSS as a descriptive language</strong>, current template system approach and their problems with <strong>modularity</strong> and <strong>extensibility</strong>, and try to mix both features from the <strong>concept</strong> to a <strong>concrete implementation</strong>.</p>\n<!--more-->\n\n<br style=\"clear: both\" />\n\n<h2 id=\"what-is-css-\">What is CSS ?</h2>\n<p>CSS is an extremely powerful descriptive language.<br>It helps to define <strong>how to display a document</strong> (e.g. a web page).</p>\n<p>A style sheet contains a set of <strong>CSS rules</strong>.<br>Each CSS rule has a <strong>CSS selector</strong> associated with a set of <strong>declarations</strong>.<br>You can see a CSS selector as a selection filter applied on every HTML element. A few element can match a CSS selector if they fit the structure describes in this selector.<br>Each <strong>declaration</strong> is composed of a couple (<strong>property</strong> : <strong>value</strong>).<br>The <strong>CSS property</strong> is a predefined property related to a display or layout behavior.<br>The <strong>value</strong> will apply a custom value for the property on all elements matching the CSS selector.</p>\n<p>Let’s focus on some advantages of this descriptive language:</p>\n<h3 id=\"a-css-rule-is-independant-from-others\">A CSS rule is independant from others.</h3>\n<p>The order of CSS rules <em>(selector declarations)</em> <strong>really</strong> does not matter.<br>The priority between CSS rules is based on the selector itself and not on their arrangement.</p>\n<h3 id=\"you-can-mix-css-rule\">You can “mix” CSS rule</h3>\n<p>2 CSS rules can have the same CSS selector. An element can be matched with multiple CSS rules. CSS rules are merged, it’s called the cascading.<br>This is the most important feature of CSS.<br>It implies a very modular and extensible language.</p>\n<h4 id=\"example\">Example</h4>\n<pre><code class=\"language-css\">a {   \n  color: #33CC00;  \n  text-decoration: none;  \n}  \na:hover { text-decoration: underline; }  \n#articles {  \n  font-size: 12px;  \n}  \n#articles a {  \n  color: red; /* overriding the generic color of a */  \n}\n</code></pre>\n<h2 id=\"some-limitations-of-todays-template-system\">Some limitations of today’s template system</h2>\n<p>Most of template system are based on inherence between templates.</p>\n<ul>\n<li>  You have usually an “inclusion” approach: a template will “include” multiple external template. <em>(Many template into Many template)</em></li>\n<li>  And an “extension” approach: You define in a main template an area where you can append a template. Others templates “extend” your main template. <em>(One main template for Many template)</em></li>\n</ul>\n<p>These approaches aims to factorize template codes and that’s great.</p>\n<p>But it doesn’t fit my needs:</p>\n<ul>\n<li>  It brings <strong>dependencies between templates</strong>. </li>\n<li>If you add a new template, you have to modify existing templates.<br>  If your application tend to go modules based, this is going to be unmaintainable. </li>\n</ul>\n<blockquote>\n<p><strong>web application module (n)</strong><br>1 : an independent unit of functionality that is part of the total structure of a web application </p>\n</blockquote>\n<h3 id=\"a-solution-for-scalable-applications-and-libraries\">A solution for scalable applications and libraries</h3>\n<p>I’ve recently started to rewrite my <a href=\"http://sliderjs.org/\">SliderJS</a> library and I needed to split it into very modular features and having loose coupling between each component.</p>\n<p>I followed this <a href=\"http://www.ubelly.com/2011/11/scalablejs/\">Scalable JavaScript Application Architecture</a> article.</p>\n<p>So, <strong>how to bring loose coupling in templating?</strong>.<br>Each module have its own template and know where to append. Bringing this logic in a main template would break the independency and if I need to add new modules soon, it will not working without modifiyng it.<br>How to keep the scalability of the main template without modifying it?</p>\n<p>The best solution I found is to combine <strong>CSS selectors</strong> concepts with <strong>template system</strong> approaches.</p>\n<h2 id=\"css-concepts-applied-on-templating\">CSS concepts applied on templating</h2>\n<p>I’ve decided to inspire from CSS: <strong>attaching a CSS selector with a template</strong>.<br>It benefits from some CSS advantages explained before.</p>\n<h3 id=\"simple-twitter-widget-example\">Simple twitter widget example</h3>\n<pre><code class=\"language-html\">&lt;div class=&quot;twitter&quot;&gt;\n  &lt;h1&gt;Twitter&lt;/h1&gt;\n  &lt;ul class=&quot;twitts&quot;&gt;\n    &lt;li class=&quot;twitt&quot;&gt;Hello world!&lt;/li&gt;\n  &lt;/ul&gt;\n  &lt;footer&gt;&lt;a href=&quot;http://twitter.com/greweb&quot;&gt;Follow me on twitter&lt;/a&gt;&lt;/footer&gt;\n&lt;/div&gt;\n</code></pre>\n<h4 id=\"classical-approach\">Classical approach</h4>\n<p>The way to template it with the classical approach would be:</p>\n<pre><code class=\"language-html\">&lt;div class=&quot;twitter&quot;&gt;\n  &lt;h1&gt;Twitter&lt;/h1&gt;\n  &lt;ul class=&quot;twitts&quot;&gt;\n    {for twitt in twitts}\n    &lt;li class=&quot;twitt&quot;&gt;{twitt}&lt;/li&gt;\n    {/for}\n  &lt;/ul&gt;\n  &lt;footer&gt;&lt;a href=&quot;http://twitter.com/{me}&quot;&gt;Follow me on twitter&lt;/a&gt;&lt;/footer&gt;\n&lt;/div&gt;\n</code></pre>\n<h4 id=\"css-selector-based-approach\">CSS selector based approach</h4>\n<p>But we can also split the original “template” in small fragments and mix all of them.<br>It helps to define each templates independently.</p>\n<p><strong>We can identify:</strong></p>\n<ul>\n<li>A <strong>root template fragment</strong>:</li>\n</ul>\n<pre><code class=\"language-html\">&lt;div class=&quot;twitter&quot;&gt;&lt;/div&gt;\n</code></pre>\n<ul>\n<li>A <strong>header fragment</strong> appended with <code>.twitter</code> selector and with an <strong>high priority</strong>:</li>\n</ul>\n<pre><code class=\"language-html\">&lt;h1&gt;Twitter&lt;/h1&gt;\n</code></pre>\n<ul>\n<li>A <strong>twitts list fragment</strong> appended with <code>.twitter</code> selector:</li>\n</ul>\n<pre><code class=\"language-html\">&lt;ul class=&quot;twitts&quot;&gt;\n  {for twitt in twitts}\n  &lt;li class=&quot;twitt&quot;&gt;{twitt}&lt;/li&gt;\n  {/for}\n&lt;/ul&gt;\n</code></pre>\n<p>with <strong>parameters</strong> <code>twitts = [ &quot;Hello world!&quot; ]</code></p>\n<ul>\n<li>An empty <strong>footer fragment</strong> appended with <code>.twitter</code> selector and with a <strong>low</strong> priority:</li>\n</ul>\n<pre><code class=\"language-html\">&lt;footer&gt;&lt;/footer&gt;\n</code></pre>\n<ul>\n<li>A “follow me” <strong>link fragment</strong> appended with <code>.twitter footer</code> selector:</li>\n</ul>\n<pre><code class=\"language-html\">&lt;a href=&quot;http://twitter.com/{me}&quot;&gt;Follow me on twitter&lt;/a&gt;\n</code></pre>\n<p>with <strong>parameters</strong> <code>me = &quot;greweb&quot;</code></p>\n<h3 id=\"advanced-example\">Advanced example</h3>\n<p>This is another example with a slider. </p>\n<p>Let’s conceptually imagine the following template language:</p>\n<pre><code class=\"language-html\">@root { html: &lt;div class=&quot;slider&quot;&gt;&lt;/div&gt; }\n\n.slider {\n  html: &lt;div class=&quot;slides&quot;&gt;&lt;/div&gt;\n}\n\n.slider div.slides {\n  html: &lt;canvas class=&quot;slides&quot;&gt;&lt;/canvas&gt;\n}\n\n.slider div.slides {\n  html:\n  &lt;div class=&quot;slide&quot;&gt;\n    &lt;a href=&quot;&lt;%= link %&gt;&quot;&gt;\n      &lt;img src=&quot;&lt;%= img %&gt;&quot; /&gt;\n      &lt;span class=&quot;caption&quot;&gt;&lt;%= title %&gt;&lt;/span&gt;\n    &lt;/a&gt;\n  &lt;/div&gt;\n}\n\n.slider {\n  priority: -10\n  html: &lt;div class=&quot;pager&quot;&gt;&lt;/div&gt;\n}\n\n.slider div.pager {\n  priority: 10\n  html: &lt;a class=&quot;prevSlide&quot; href=&quot;javascript:;&quot;&gt;prev&lt;/a&gt;\n}\n\n.slider div.pager {\n  priority: -10\n  html: &lt;a class=&quot;nextSlide&quot; href=&quot;javascript:;&quot;&gt;next&lt;/a&gt;\n}\n\n.slider div.pager {\n  html: &lt;span class=&quot;pages&quot;&gt;&lt;/span&gt;\n}\n\n.slider div.pager {\n  html: &lt;span class=&quot;pages&quot;&gt;\n    &lt;% for (var i=0; i&lt;slides.length; ++i) { %&gt;\n    &lt;a class=&quot;page&quot; href=&quot;javascript:;&quot;&gt;&lt;%= i+1 %&gt;&lt;/a&gt;\n    &lt;% } %&gt;\n  &lt;/span&gt;\n}\n</code></pre>\n<p>combined with some parameters, it will result</p>\n<pre><code class=\"language-html\">&lt;div class=&quot;slider&quot;&gt;\n  &lt;div class=&quot;slides&quot;&gt;\n    &lt;div class=&quot;slide&quot;&gt;&lt;a href=&quot;..&quot;&gt;&lt;img src=&quot;..&quot;/&gt;&lt;span class=&quot;caption&quot;&gt;...&lt;/span&gt;&lt;/a&gt;&lt;/div&gt;\n    &lt;div class=&quot;slide&quot;&gt;...&lt;/div&gt;\n    &lt;div class=&quot;slide&quot;&gt;...&lt;/div&gt;\n    &lt;canvas class=&quot;slides&quot;&gt;&lt;/canvas&gt;\n  &lt;/div&gt;\n  &lt;div class=&quot;pager&quot;&gt;\n    &lt;a href=&quot;javascript:;&quot; class=&quot;prevSlide&quot;&gt;prev&lt;/a&gt;\n    &lt;div class=&quot;pages&quot;&gt;\n      &lt;a href=&quot;javascript:;&quot; class=&quot;page&quot;&gt;1&lt;/a&gt;\n      &lt;a href=&quot;javascript:;&quot; class=&quot;page&quot;&gt;2&lt;/a&gt;\n      &lt;a href=&quot;javascript:;&quot; class=&quot;page&quot;&gt;3&lt;/a&gt;\n    &lt;/div&gt;                                                                      \n    &lt;a href=&quot;javascript:;&quot; class=&quot;nextSlide&quot;&gt;next&lt;/a&gt;\n  &lt;/div&gt;\n&lt;/div&gt;\n</code></pre>\n<p>Of-course we could also do this programmatically with DOM. But see the benefit of such a descriptive way to define things?</p>\n<p>You should keep in mind that <strong>the order of rules definition does not matter</strong>. In that’s sense, it is <strong>a mixable, extensible, modular and loosely-coupled template system</strong>.</p>\n<h3 id=\"more-about-this-poc\">More about this POC</h3>\n<p>Unlike CSS, <strong>two same rules aren’t merged but are appended</strong>.</p>\n<p>The <em><strong>priority</strong></em> governs the order of append. The higher the value is, the sooner it is appended to the containers selected by the CSS selector.</p>\n<p>As you can see, there is a <strong>micro-templating</strong> inside each rule. For this example, it looks like the John Resig ‘s Micro Templating.</p>\n<p>Note also that a rule must be aware of its <strong>parameters</strong> to work properly. But this only concerns the implementation: You have to find a way to give a dynamic reference of these parameters when you add a rule.</p>\n<h3 id=\"concrete-implementation\">Concrete implementation</h3>\n<p>The code above was a conceptual proof of concept, but I implement a subset of these features in Javascript and made “SelectorTemplating.js” available here : <a href=\"https://gist.github.com/1731611\">https://gist.github.com/1731611</a></p>\n<p>This is how it can be used for (almost) the same example. You will see different style of usage:</p>\n<pre><code class=\"language-javascript\">var node = document.getElementById(&quot;slider&quot;);\nvar t = new SelectorTemplating(node);\nvar tmpl; // defined somewhere, the John Resig &#39;s Micro Templating.\n\n// root module\nfunction root () { return &#39;&lt;div class=&quot;slider&quot;&gt;&lt;/div&gt;&#39; }\nt.add(null, root);\n\n// slides module\nvar slidesTmpl = tmpl(&#39;&lt;div class=&quot;slides&quot;&gt; &lt;% if(obj.slides) { for(var i=0; i&lt;slides.length; ++i) { var s = slides[i]; %&gt; &lt;div class=&quot;slide&quot;&gt; &lt;a href=&quot;&lt;%= s.link %&gt;&quot;&gt; &lt;img src=&quot;&lt;%= s.img %&gt;&quot; /&gt; &lt;span class=&quot;caption&quot;&gt;&lt;%= s.title %&gt;&lt;/span&gt; &lt;/a&gt; &lt;/div&gt; &lt;% }} %&gt; &lt;/div&gt;&#39;)\nvar slides = [ ... ]; // mutable\nt.add(&quot;.slider&quot;, function () { return slidesTmpl(slides: slides) });\n\n// canvas module\nt.add(&quot;.slider div.slides&quot;, function () { return &#39;&lt;canvas class=&quot;slides&quot;&gt;&lt;/canvas&gt;&#39; });\n\n// pager module\nvar pagesTmpl = tmpl(&#39;&lt;div class=&quot;pager&quot;&gt; &lt;span class=&quot;pages&quot;&gt; &lt;% if(obj.slides) { for(var i=0; i&lt;slides.length; ++i) { %&gt; &lt;a href=&quot;javascript:;&quot; class=&quot;page&quot;&gt;&lt;%= i+1 %&gt;&lt;/a&gt; &lt;% }} %&gt; &lt;/span&gt; &lt;/div&gt;&#39;);\nvar slides = [...]; // synchronised with the slides module\nvar prevButton, nextButton; // DOM element init when templated\nvar pages = function () {\n  return pagesTmpl(slides: slides);\n}\nt.add(&quot;.sliderjs&quot;, pages, null, -10);\nt.add(&quot;.sliderjs .options&quot;, function () { return &#39;&lt;a class=&quot;prevSlide&quot; href=&quot;javascript:;&quot;&gt;prev&lt;/a&gt;&#39; }, function (n) { prevButton = n[0] }, 10 }); // prepend first in options\nt.add(&quot;.sliderjs .options&quot;, function () { return &#39;&lt;a class=&quot;nextSlide&quot; href=&quot;javascript:;&quot;&gt;next&lt;/a&gt;&#39; }, function (n) { nextButton = n[0] }, -10 }); // append at the end of options\n\n// when all modules are init :\nt.init();\n</code></pre>\n<pre><code>t.add (selector, templateFunction, callback, priority)\n * selector is the selector function. if null, append to root.\n * a template function is an identifier in the template.\n * the callback is called at the end of the templating with 2 arguments : the appended nodes and the global container.\n</code></pre>\n<h4 id=\"algorithm-of-the-template-process\">Algorithm of the template process</h4>\n<pre><code>container := the container element\nrules := an array containing all rules.\nsort rules by priority.\n(1) take one rule from rules\n  - elements := []\n  - if the selector is @root, elements := [container]\n  - otherwise, elements := all elements which matches the selector\n  - if the elements is empty, back to (1) by taking the next rule.\n  - (2) if not, templatize the html and append it into all of these elements. remove the rule from rules. back to (1) by starting from the first rules. \n\nthe loop (1) must end when :\n  - there is no rules anymore\n  - you have covered all the rules array without finding a match (without passing by (2) for this loop). In that case, it means some rules are not used.\n</code></pre>\n<p>There is a known limitation of the algorithm I intend to fix soon:\nOnce we found matching elements for a rule, we append the template in these elements once, and we remove the rule. It’s a simple way to avoid recursion. But this approach doesn’t work if a selector can potentially matches elements defined in different rules. <strong>I know how to fix this but it’s not yet implemented.</strong></p>\n<h2 id=\"whats-next\">What&#39;s next?</h2>\n<p>We are working hard for the next version (v2) of <a href=\"http://sliderjs.org\">SliderJS</a> by trying to make a revolutionary IDE platform for SliderJS. It requires a modulification of every components of SliderJS, we try to keep things simple (no external library required, the core system is only 4k sized). You will have more information soon!</p>\n<p>This templating system should benefits of this work.</p>\n<p>Keep in touch!</p>\n","data":{"title":"CSS-selector-based templating system for scalable JavaScript applications","description":"In this article, we will focus on the power of CSS as a descriptive language, current template system approach and their problems with modularity and extensibility, and try to mix both features from the concept to a concrete implementation.","thumbnail":"/images/2012/02/218px-Mir_diagram-fr.svg_.png","author":"Gaetan","layout":"post","permalink":"/2012/02/css-selector-based-templating-example-with-javascript/","tags":["css","javascript","templating"]}},"__N_SSG":true}
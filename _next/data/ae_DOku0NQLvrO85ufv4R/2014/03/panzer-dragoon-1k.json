{"pageProps":{"id":"2014-03-12-panzer-dragoon-1k","year":"2014","month":"03","day":"12","slug":"panzer-dragoon-1k","content":"<p><a href=\"http://js1k.com/2014-dragons/demo/1790\"><img src=\"/images/2014/03/js1k.png\" alt=\"\" class=\"thumbnail-left\" /></a></p>\n<p>This article introduces my journey into the JS1K world\nand a few tricks I&#39;ve used for my entry <a href=\"http://js1k.com/2014-dragons/demo/1790\">&quot;Panzer Dragoon 1k&quot;</a> (<a href=\"https://gist.github.com/gre/9504494\">source</a>).</p>\n<p>Welcome to the world of hacks, tricks and getting-things-done-at-any-price.\nYou will turn the worst JavaScript practices and ugliest JavaScript facts to your advantage.\nWelcome to the world where coding the bad way is satisfying!</p>\n<h2 id=\"panzer-dragoon-1k\">Panzer Dragoon 1k</h2>\n<ul>\n<li><strong><a href=\"http://js1k.com/2014-dragons/demo/1790\">Play the JS1K entry</a></strong></li>\n<li><a href=\"https://gist.github.com/gre/9504494\">Source Code</a></li>\n</ul>\n<h2 id=\"panzer-dragoon-original-game\">Panzer Dragoon Original Game</h2>\n<iframe width=\"640\" height=\"480\" src=\"//www.youtube.com/embed/peoRBj9U-jI\" frameborder=\"0\" allowfullscreen></iframe>\n\n<!--more-->\n\n<h1 id=\"js1k\">JS1K</h1>\n<p><strong><a href=\"http://js1k.com/\">JS1K</a></strong> is a competition where you have to make a demo (or a game, or anything)\nin less than <strong>1 kilobytes</strong> of JavaScript: <strong>less than 1024 characters of source code</strong>.</p>\n<p>To reach that goal you will need ideas, JS ninja tricks \nand most important: <strong>patience and perseverance</strong>!\nBut really, <strong>anyone can participate</strong>.</p>\n<p>I recommend that you take a look at <a href=\"http://js1k.com/\">js1k.com</a> and browse the existing entries.\nThere is awesome guys participating to this yearly event,\nI had the chance to meet some of them at <a href=\"http://demojs.org/\">DemoJS 2013</a> Paris event.\nAlso checkout <a href=\"http://www.p01.org/\">www.p01.org</a> which contains some very good examples of crazy short demos.</p>\n<h2 id=\"tools\">Tools</h2>\n<p>But first things first: you need tools to minimize source code (it can simply be removing comments and spaces, minifiers, or it can be much more crazy tools like crushers).</p>\n<p>Personally, I&#39;m using:</p>\n<pre><code class=\"language-bash\">cat source.js | uglifyjs -c unused=false | tee minified.js | jscrush &gt; crushed.js &amp;&amp; wc -c *.js\n</code></pre>\n<p>This small homemade command (to use in a npm script) results for my game in:</p>\n<pre><code>    1019 crushed.js\n    1756 minified.js\n    7241 source.js\n</code></pre>\n<p>If you are interested, I&#39;ve made this toolkit available in a complete boilerplate \nthat you can easily fork for your own usage: \n<a href=\"https://gist.github.com/gre/9364718\">https://gist.github.com/gre/9364718</a>.</p>\n<blockquote>\n<p><strong>P.S.</strong> <a href=\"https://github.com/gre/jscrush/\"><code>jscrush</code></a> is a npm module that you can directly use from the CLI \nbut it is a port of the awesome <a href=\"http://www.iteral.com/jscrush/\">www.iteral.com/jscrush/</a>.</p>\n</blockquote>\n<h1 id=\"the-beginning-saving-bytes\">The beginning: Saving bytes</h1>\n<p>It quickly becomes frustrating to compete in JS1K\nbecause you are basically trying to put a cow in a car (or an elephant if you are ambitious!).\nBut this frustration actually becomes addictive!</p>\n<p><strong>Saving bytes</strong> is your job - once you get your first working prototype, and inevitably blow your byte limit.</p>\n<p>When you reach that limit, a good idea is to practice an <strong>&quot;add feature -&gt; remove code&quot;</strong> development loop \nthat really makes you think hard about your ultimate goal, and helps improve your entry.</p>\n<blockquote>\n<p><strong>The JS1K-based development:</strong>\nAdding more and more features,\nfiguring out how to fill everything in,\nre-thinking your demo to only keep the essential features.\nThis will keep making your demo better.</p>\n</blockquote>\n<p>You have to make a very hard choice: <em><strong>Which feature to remove?</strong></em>\nIt is all about budget, not in term of money but in term of bytes!\nA bit like in daily life: making choices with limited resources!</p>\n<h2 id=\"jscrush\">JSCrush</h2>\n<p><em><strong>JSCrush</strong></em> is a crazy tool you may want to use to go deeper in the bytes reducing.</p>\n<p>It basically implements a compression algorithm which is based on substring occurences.\nThe challenge of such a tool is not only to make a good compression but to make \na very small decompressor embedded in the result code because \nthis decompressor might be an overhead <em>(~ +60 bytes with small code)</em>.</p>\n<p>If you are using <em>JSCrush</em> which I recommend for saving extra bytes,\nyou may want to use some tricks to go even further with it!</p>\n<p>The first time, you usually can save about 20% of bytes with classic 1k minified code.\nBut if you optimize your code <strong>for</strong> <em>JSCrush</em>, you can save much more!\nI&#39;ve achieved about a 40% code reduction in my demo!</p>\n<p>Most of the tricks is about finding code patterns (same succession of JavaScript source code characters) \nand trying to duplicate them.</p>\n<p>When I say <strong>duplicating code</strong>, it is really about <strong>DUPLICATING code!</strong></p>\n<blockquote>\n<p>Once &quot;indexed&quot;, a duplicated code is likely to just take one more byte in the final crushed JavaScript!</p>\n</blockquote>\n<h1 id=\"some-tips-and-tricks\">Some tips and tricks</h1>\n<p><a href=\"http://js1k.com/2014-dragons/demo/1790\"><img src=\"/images/2014/03/js1k_2.png\" alt=\"\" class=\"thumbnail-right\" /></a></p>\n<p>This section will share with you a non-exhaustive list of tricks.\nI&#39;m not going to talk so much about the basic and classic ones, \nbut a few novel ones that I found to work well in my entry.\nYou may prefer to directly read the <a href=\"https://gist.github.com/gre/9504494\">annotated source code of &quot;Panzer Dragoon 1K&quot;</a> instead!\nOf course, most of those tricks work closely with the <code>| minify | jscrush</code> transformation.</p>\n<blockquote>\n<p>Careful! Some tricks might be counter-intuitive as first glance, \nagain it ties-in with the way JSCrush is working.</p>\n</blockquote>\n<h2 id=\"reduce-your-language\">Reduce your language</h2>\n<p>All existing functions and properties are costly in bytes,\neach time you use another one, it definitely add bytes.\nTo save bytes, you have to limit your set of functions/properties to use\nor find ways to access them indirectly.</p>\n<ul>\n<li><strong>Use as few variables as you can</strong>: this is valid in computer science in general: the best systems are those with the fewest possible variables (states). if one variable can be computed out of others, it should be removed. Also consider allocating some temporary variables to re-use like in an assembly registry (e.g. <code>i</code>, <code>j</code>).</li>\n<li><strong>Reduce the set of functions</strong> you authorize yourself to use! You may just need to use &quot;fillRect&quot; for everything, or &quot;arc&quot;. Also don&#39;t use both <code>Math.min</code> and <code>Math.max</code>, one can be implemented with the other.</li>\n<li><strong>Minimize the different values / colors</strong> you are using (most of the time digits are fine, but <code>#RGB</code> colors are costy).</li>\n</ul>\n<h2 id=\"duplicated-wins\">Duplicated wins!</h2>\n<ul>\n<li><p>Generally: try to <strong>duplicate the exact same code everywhere</strong>!</p>\n</li>\n<li><p><strong>Do not use explicit aliasing</strong> like <code>M=Math</code> and <code>C=M.cos</code>, JSCrush does that job for you.</p>\n</li>\n<li><p><strong>Get rid of intermediary computation.</strong> Prefer inline and duplicated computation over variable assigment.</p>\n</li>\n<li><p>Also, <code>a*(b+c)</code> might be more bytes than <code>a*b+a*c</code> if <code>a</code> is an expression. (but doesn&#39;t work in all cases)</p>\n</li>\n</ul>\n<p><strong>A few examples:</strong></p>\n<pre><code class=\"language-javascript\">a = b+c; translate(a, a); // NOPE!\ntranslate(b+c, b+c); // YES!\n</code></pre>\n<pre><code class=\"language-javascript\">size = a+b+10; fillRect(x-size, y-size, 2*size, 2*size); // no please don&#39;t!\nfillRect(x-(a+b+10), y-(a+b+10), 2*(a+b+10), 2*(a+b+10)); // YEAH!\n</code></pre>\n<pre><code class=\"language-javascript\">fillRect(10,10,20,20);\n...\nfillRect(9,9,18,18); // Can you afford to use 10,10,20,20 instead?\n</code></pre>\n<p>In my demo, I was able to factorize some code. For instance the way I draw and update the x,y of my opponents and particles are the same duplicate chunk of code:</p>\n<pre><code class=\"language-javascript\">    bga();\n    arc(\n      // Update\n      e[0] += e[3],\n      e[1] += e[4],\n      e[2],\n      0, 9);\n    fl();\n</code></pre>\n<ul>\n<li>You sometimes can <strong>save bytes by adding more code</strong>! For instance, if you need <code>fillStyle</code> and <code>strokeStyle</code>, it may save bytes to always set both color at the same time! <code>fillStyle = strokeStyle = ...</code> even if you only need once.</li>\n<li>Always <strong>use the same <code>function parameters</code></strong>. In my game, I use <code>function(e){</code> everywhere even if I don&#39;t use that <code>e</code> in all my functions. This is saving a bunch of bytes with JSCrush.</li>\n<li><strong>Here&#39;s a particularly crazy trick:</strong> If you have different collections of complex objects, you can simply represent each item by a vector (an array) and figure out how you can make use the same indexes for the use-case.</li>\n</ul>\n<p>In my game:</p>\n<pre><code class=\"language-javascript\">o = []; // an opponent: [ 0: x, 1: y, 2: health, 3: vx, 4: vy, 5: locked, 6: hitTime ]\np = []; // a particule: [ 0: x, 1: y, 2: size,   3: vx, 4: vy, 5: damage ]\n</code></pre>\n<ul>\n<li>You also may find better way of managing collections. Instead of using <code>t.push(o)</code> to add, <code>t.splice(i, 1)</code> to remove, and <code>for(i=0;e=o[i];i++){...}</code> to iterate. I am using <code>t[Math.random()]=o</code> to add, <code>delete t[i]</code> to remove and <code>for(i in o){ e=o[i]; ... }</code> to iterate. It saved a lot of bytes if you already use <code>Math.random()</code> somewhere else! For-in loops are also quite short and can by used for other tricks (e.g. <em>Programmatical aliasing</em>).</li>\n</ul>\n<blockquote class=\"twitter-tweet\" lang=\"fr\"><p>My <a href=\"https://twitter.com/search?q=%23js1k&amp;src=hash\">#js1k</a> uses `t[Math.random()]=insert`, for-in loops and `delete t[i]` rather than push and splice. Saving bytes with jscrush</p>&mdash; Gaëtan Renaudeau (@greweb) <a href=\"https://twitter.com/greweb/statuses/439324052403277824\">28 Février 2014</a></blockquote>\n\n\n<ul>\n<li>Use just <strong>one letter variable names</strong> (mangling variables won&#39;t work because they are in window scope, and IMHO it is better for you to write them by hand)</li>\n<li>You will probably need to <strong>initialize some variables</strong>, but do it only if necessary (if you have <code>ReferenceError</code>) and <strong>use the multi-assignment syntax</strong>: <code>A = B = 0</code> if you can. You should never have constant variables, it saves bytes to directly use the value inline.</li>\n<li><strong><code>with(c){ ... }</code></strong> in your main loop may save bytes. It makes all functions and properties of c (the drawing context) in the scope.</li>\n</ul>\n<h2 id=\"language-tricks\">Language tricks</h2>\n<ul>\n<li><strong>Never use <code>var</code></strong>, just put everything in <code>window</code></li>\n<li><strong>Programmatically aliasing <code>c</code>&#39;s method</strong> may save you a lot of bytes (or may not, you have to check!). You also have to find the code which suit the best your use case. Be careful about collision. Here is mine: <code>for (e in c) c[e[0]+e[2]+(e[6]||&quot;&quot;)] = c[e];</code></li>\n<li>Do not waste ANY value returned by assignment and operators (i++, x=.., x+=...). I&#39;m sure you can do it somewhere else!\nTypical example:</li>\n</ul>\n<pre><code class=\"language-javascript\">x += vx; y += vy; /* ... */ fillRect(x, y, s, s); // NOPE!\n/* ... */ fillRect(x += vx, y += vy, s, s); // YES!\n</code></pre>\n<ul>\n<li>Try to not separate update from drawing logic. Mixing them may save bytes.</li>\n<li>You don&#39;t want to use <code>addEventListener</code>, just define listeners straight on window! e.g. <code>onclick = function(){...</code></li>\n</ul>\n<h2 id=\"make-your-js1k-now\">Make your JS1K now!</h2>\n<p><a href=\"http://js1k.com/2014-dragons/demo/1790\"><img src=\"/images/2014/03/js1k_3.png\" alt=\"\" class=\"thumbnail-left\" /></a></p>\n<p>I&#39;m really eager to see all JS1K entries \nbecause I usually enjoy reading people&#39;s code and \nespecially all the crazy tricks that I can learn from your code :-)</p>\n<p>This article was just sharing a bunch of tricks which work for my entry,\nbut you will find much better tricks for your demo -\nso please do it and make your crazy work!</p>\n<hr>\n<p><em>Special thanks to <a href=\"http://twitter.com/mrspeaker\">@mrspeaker</a> for fixing my English</em>.</p>\n","data":{"title":"Panzer Dragoon 1k","description":"Panzer Dragoon 1k is a 2D remake of Panzer Dragoon in 1k of JavaScript I made for JS1K 2014","thumbnail":"/images/2014/03/js1k.png","author":"Gaetan","layout":"post","tags":["gamedev","js1k","javascript","canvas"]}},"__N_SSG":true}
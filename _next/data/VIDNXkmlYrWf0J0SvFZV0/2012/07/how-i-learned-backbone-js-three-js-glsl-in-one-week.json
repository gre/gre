{"pageProps":{"id":"2012-07-03-how-i-learned-backbone-js-three-js-glsl-in-one-week","year":"2012","month":"07","day":"03","slug":"how-i-learned-backbone-js-three-js-glsl-in-one-week","content":"<p><img src=\"/images/2012/07/dta1.png\" alt=\"\"></p>\n<p>Last week was the <a href=\"http://7dfps.org/\">7dfps challenge</a>, an open challenge where participants had to make a FPS in only one week.\nSuch contest are very very interesting for those who want to experiment with things. Challenging yourself is IMO the best way to learn new things. You may also know the famous <a href=\"http://www.ludumdare.com/\">“Ludum Dare” contest</a>.</p>\n<p>I learned to use Backbone.js and Three.js (a famous library on top of WebGL) in only one week, so you have no excuse to not be able to do the same!</p>\n<p><a href=\"http://youcanmakevideogames.com/\">-&gt; You can make games!</a></p>\n<blockquote>\n<p>“If Lawnmower Man f****d Tron on the bonnet of a tank”<br><strong><em>YouBigNugget</em></strong></p>\n</blockquote>\n<p>I’ve only used web technologies, no need of any plugin, just a recent browser like Chrome / Firefox.</p>\n<p>This is the result:</p>\n<iframe width=\"640\" height=\"360\" src=\"http://www.youtube.com/embed/g9CldBI9C6E?feature=player_embedded\" frameborder=\"0\" allowfullscreen></iframe>\n\n<p>and you can play it here:</p>\n<p><strong><a href=\"http://gre.github.io/dta\">Play the game</a></strong></p>\n<!--more-->\n\n<h2 id=\"overview-of-a-one-week-game-development\">Overview of a one week game development</h2>\n<h3 id=\"backbonejs-for-the-model-events-and-class-inherence\">Backbone.js, for the model, events and class inherence</h3>\n<p>I’m a fan of the “do it yourself” idea, not using any library or only using small 140byt.es codes. But the frequent issue with that is (1) always doing the same thing again and again, (2) taking a lot of time on the architecture, and not finishing anything. When you have a due date, relying on libraries and frameworks could save you a lot of time.<br>I’ve choose Backbone.js for its Model architecture with class inherence, a get/set system, and also its event system bound to model instances, the destroy function with the “destroy” event to bind on,… It was also a new library to learn for me.</p>\n<h4 id=\"models\">Models</h4>\n<p>Here is the class diagram of the game:</p>\n<p><img src=\"/images/2012/07/f5dea341.jpg\" alt=\"not available\"></p>\n<h3 id=\"learning-threejs-a-3d-library-on-top-of-webgl\">Learning Three.js, a 3D library on top of WebGL.</h3>\n<p>WebGL is <a href=\"http://caniuse.com/#search=webgl\">more and more supported by browsers</a>.<br>WebGL means OpenGL in the web. It allows to make efficient and hardware accelerated 3D computation.</p>\n<p>Here is the same, not using any library but using pure WebGL wasn’t possible in one week! This is why I’ve chosen to use Three.js, probably today the most popular WebGL library.<br>I was impressed how Three.js is finally not so hard to use, knowing some basic 3D concepts from my old Blender days.</p>\n<p>You create a <code>Scene</code>, add a <code>Camera</code>, add Meshes to the scene, A <code>Mesh</code> has a <code>Material</code> and a <code>Geometry</code>, … everything very straighforward.</p>\n<p>One challenging part was when trying to compute global world position relative to a given object position, for instance to compute the Bullet initial position and orientation from the Tank position and orientation.</p>\n<p>Fortunately I’ve got some help <img src=\"http://gre.github.io/dta\" alt=\":)\"> and got the answer: multiply your vector with the worldMatrix of the mesh.</p>\n<blockquote class=\"twitter-tweet\" data-in-reply-to=\"212609230891524096\" width=\"550\" lang=\"fr\"><p>@<a href=\"https://twitter.com/greweb\">greweb</a> Should be calculatable quite easily. Multiply the position vector by the object’s matrixWorld property.</p>\n<p>&mdash; Paul Lewis (@aerotwist) <a href=\"https://twitter.com/aerotwist/status/212617930024816641\" data-datetime=\"2012-06-12T18:50:39+00:00\">Juin 12, 2012</a></p></blockquote>\n\n<blockquote class=\"twitter-tweet\" data-in-reply-to=\"212609230891524096\" width=\"550\" lang=\"fr\"><p>@<a href=\"https://twitter.com/greweb\">greweb</a> var position = new THREE.Vector3().getPositionFromMatrix( object.matrixWorld );</p>\n<p>&mdash; Mr.doob (@mrdoob) <a href=\"https://twitter.com/mrdoob/status/212648943673290752\" data-datetime=\"2012-06-12T20:53:53+00:00\">Juin 12, 2012</a></p></blockquote>\n\n<h3 id=\"playing-with-ai\">Playing with AI</h3>\n<p>Like TankKeyboardControls, I’ve created a new “TankControls” for computer tanks: <strong>TankRandomControls</strong> was the first dumb one, it just does random things:</p>\n<pre><code class=\"language-javascript\">function TankRandomControls () {\nvar self = this;\nself.moveForward = false;\nself.moveBackward = false;\nself.moveLeft = false;\nself.moveRight = false;\nself.fire = false;\nself.fireMissile = false;\nvar i = ;\nsetInterval (function () { // take random decisions every 0.5 second\n  i;\nself.moveForward = i%3== &amp;&amp; Math.random() &gt; 0.2;\nself.moveBackward = !self.moveForward &amp;&amp; Math.random() &gt; 0.5;\nself.moveLeft = Math.random() &lt; 0.1;\nself.moveRight = Math.random() &lt; 0.1;\nself.fire = Math.random() &gt; 0.2;\nself.fireMissile = Math.random() &lt; 0.2;\n}, 500);\n}\n</code></pre>\n<p><strong>TankRemoteControls</strong> was the second one using some simple AI rules:</p>\n<ul>\n<li>Try to avoid walls and objects</li>\n<li>Either do random things or target a tank (more likely)</li>\n<li>Target the closest tank, update target every 5 seconds</li>\n<li>Turn the tank to the target tank, shoot bullets and missiles</li>\n<li>Move forward if the target is far away / Move backward if the target is too close</li>\n</ul>\n<p>See the source code here: .</p>\n<h3 id=\"sounds\">Sounds</h3>\n<p>I’ve used <a href=\"http://www.egonelbre.com/js/jsfx/\">JSFX</a>, an experimental library, were you can generate sounds based on a few parameters.<br>It’s a 8-bit sound generator perfect for generate old-school sounds.</p>\n<p>So you can create each sound in Javascript like this:</p>\n<pre><code class=\"language-javascript\">SOUNDS = {\n  bullet: jsfxlib.createWave([\n    &quot;noise&quot;,\n    7.0,\n    0.18,\n    0.0,\n    0.082,\n    0.0,\n    0.222,\n    20.0,\n    800,\n    2400.0,\n    -0.428,\n    0.0,\n    0.0,\n    0.01,\n    0.0003,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.992,\n    0.0,\n    0.0,\n    0.22,\n    0.0,\n  ]),\n  missile: jsfxlib.createWave([\n    &quot;noise&quot;,\n    0.0,\n    0.12,\n    0.0,\n    0.546,\n    0.0,\n    0.856,\n    64.0,\n    250,\n    1063.0,\n    0.28,\n    0.086,\n    0.024,\n    5.4329,\n    0.3565,\n    0.466,\n    -0.638,\n    0.058,\n    0.008,\n    0.0,\n    0.0,\n    -0.114,\n    0.216,\n    0.98,\n    -0.984,\n    1.0,\n    0.307,\n    0.988,\n  ]),\n  explosion: jsfxlib.createWave([\n    &quot;noise&quot;,\n    1.0,\n    0.4,\n    0.02,\n    0.682,\n    1.746,\n    1.97,\n    100.0,\n    378.0,\n    2242.0,\n    -0.55,\n    -0.372,\n    0.024,\n    0.4899,\n    -0.1622,\n    0.262,\n    0.34,\n    0.724,\n    0.0205,\n    -0.102,\n    0.0416,\n    -0.098,\n    0.1,\n    0.805,\n    0.094,\n    0.428,\n    0.0,\n    -0.262,\n  ]),\n  collideWall: jsfxlib.createWave([\n    &quot;noise&quot;,\n    0.0,\n    0.4,\n    0.0,\n    0.056,\n    0.0,\n    0.296,\n    20.0,\n    560.0,\n    2400.0,\n    -0.482,\n    0.0,\n    0.0,\n    0.01,\n    0.0003,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n    1.0,\n    0.0,\n    0.0,\n    0.0,\n    0.0,\n  ]),\n};\n// ...\n// SOUNDS.bullet.play()\n</code></pre>\n<p>The jsfxlib.createWave function returns a HTML5 Audio element and you can play with its API (.play(), .pause(), …).<br>But doing this way, you will not be able to play a sound at the same time so I’ve made a buffer system which duplicate N times the sound in different audio elements.<br>I have also try to generate different sounds to randomize it a little.</p>\n<p>See the full source code here: .</p>\n<h3 id=\"post-processing-effects-with-glsl-shaders\">Post Processing Effects with GLSL shaders</h3>\n<p>I was very impressed by the power of GLSL for its possibilities and efficiency.<br>GLSL are definitely the indispensable thing you need to add a better atmosphere in your games.</p>\n<h4 id=\"before\">Before</h4>\n<p><img src=\"/images/2012/06/before.png\" alt=\"\"></p>\n<h4 id=\"after\">After</h4>\n<p><img src=\"/images/2012/06/after_.png\" alt=\"\"></p>\n<p>and when getting shot:</p>\n<p><img src=\"/images/2012/06/after.png\" alt=\"\"></p>\n<p>These effects are done by combining these two GLSL effects.<br>Here is the GLSL code of these effects.</p>\n<h4 id=\"the-radio-noise-effect\">The radio noise effect</h4>\n<script src=\"https://gist.github.com/2950478.js?file=radionoise.frag\"></script>\n\n<h4 id=\"the-shot-interference\">The shot interference</h4>\n<script src=\"https://gist.github.com/2950478.js?file=perturbation.frag\"></script>\n\n<h3 id=\"wait-what-is-this-crazy-glsl-language\">Wait! what is this crazy “GLSL” language?</h3>\n<p>GLSL is an OpenGL language close to the C syntax design to have a direct control of the graphic pipeline. You can directly add passes to the rendering process with GLSL shaders.<br>GLSL gives you a lot of very useful types (like vectors, matrix, …) and functions (like smoothstep, …). <a href=\"http://www.opengl.org/documentation/glsl/\">Read the spec</a> to know more about it.<br>I also recommend you to experiment the <a href=\"http://glsl.heroku.com/\">GLSL Sandbox</a>. You can see awesome demos and their codes shared by people made with GLSL. It also have an online IDE to easily code and instantly test your shaders.</p>\n<h3 id=\"webgl-and-threejs-integration\">WebGL and Three.js integration</h3>\n<p>You can use GLSL in different ways with Three.js. You can add a GLSL shader to an object material, and you can also add GLSL shaders on top of the Canvas (post-processing). We will only see how to add GLSL shaders as a post processing render on the entire Canvas.</p>\n<p>Fortunately Three.js have some utils classes to make the GLSL shaders integration easier.</p>\n<p>I have been inspired from the awesome work done here: .</p>\n<p>There is a lot of code out there, so I’ve try to extract the minimum required for mixing the 2 GLSL shaders for a post-processing on the entire canvas of a Three.js scene:</p>\n<iframe style=\"width: 100%; height: 400px;\" src=\"http://jsfiddle.net/jggvJ/7/embedded/\" frameborder=\"0\" width=\"320\" height=\"240\"></iframe>\n\n<p>As you can see, you can easily inject your own Javascript variables in a GLSL shader to make a bridge between the JS and the GLSL code and so having quite generic and configurable shaders.<br>Quite cool!</p>\n<h3 id=\"adding-game-ui\">Adding game UI</h3>\n<p>Web, with HTML and CSS, allows to have different containers, layers, positioning systems,…<br>Perfect! For the game UI, we used different elements:</p>\n<p><img src=\"/images/2012/06/ui.png\" alt=\"\"></p>\n<p>Radar and Damage are implemented with an independent Canvas while Level is a simple text div.</p>\n<p>For instance, this is Damage (I called LifeIndicator):</p>\n<pre><code class=\"language-javascript\">(function(){\n\nvar LifeIndicator = function (nodeId) {\nthis.canvas = document.getElementById(nodeId);\nthis.ctx = this.canvas.getContext(&quot;2d&quot;);\nthis.life = 1;\nthis.render();\n}\n\nLifeIndicator.prototype.setLife = function (life) {\nthis.life = life;\nthis.render();\n}\n\nLifeIndicator.prototype.render = function () {\nvar c = this.ctx;\nvar w = c.canvas.width, h = c.canvas.height;\nc.clearRect(, , w, h);\n// TODO\nvar g = Math.floor(255*this.life);\nvar r = 255-g;\nc.fillStyle = &quot;rgb(&quot; r &quot;,&quot; g &quot;,0)&quot;;\nvar wt = 6;\nvar ht = 12;\nc.fillRect((w-wt)/2, , wt, ht);\nc.fillRect(, ht, w, h);\n}\n\nwindow.LifeIndicator = LifeIndicator;\n\n}());\n</code></pre>\n<h2 id=\"play-framework-integration\">Play Framework integration</h2>\n<p>I was planning to make a multiplayer game but I couldn’t find the time for this.<br>I use Play Framework 2 and its power and concepts for handling streams (even if I don’t use it yet).<br>The only part I can show you for now is the game map generation. For making a multiplayer game, I needed to have the game state on server side to be able to submit game infos (map, players, …) to new players.</p>\n<p>This is a few scala code to generate a nice distribution of random objects in the map:</p>\n<pre><code class=\"language-scala\">object Game {\n  def createRandom: Game = {\n    val random = new Random()\n    val half = 5000\n    val size = 2*half\n    val split = 4\n    val objects =\n    Range(, split).map { xi =&gt;\n      Range(, split).map { yi =&gt;\n        val s = size.toDouble / split.toDouble\n        val x = -half.toDouble math.round(s*(xi random.nextDouble));\n        val y = -half.toDouble math.round(s*(yi random.nextDouble));\n        var sizeRandom = random.nextDouble\n        val w = 200.*math.ceil((1-sizeRandom)*8.);\n        val h = 200.*math.ceil(sizeRandom*8.);\n        RectObj(Vec3(x,y,), w, h)\n      }.toList\n    }.toList.flatten\n    Game( (Vec3(-half, -half, ), Vec3(half, half, )), List(), objects, List() )\n  }\n}\n\ncase class Game (bounds: Tuple2[Vec3, Vec3], chars: List[Char], objects: List[GameObj], dynamics: List[GameDyn])\n...\n</code></pre>\n<p><a href=\"https://github.com/gre/dta/blob/master/app/models/models.scala\">See the full source</a> (some code may not be used).</p>\n<h2 id=\"still-an-unfinished-game\">Still an unfinished game</h2>\n<p>There is more things to do now:</p>\n<ul>\n<li>More visual effects</li>\n<li>More sound effects</li>\n<li>A better collision system (using a physic engine?)</li>\n<li>Multiplayer</li>\n<li>A better gameplay with some goals, different kind of games, …</li>\n</ul>\n<h3 id=\"initial-multiplayer-objective-rescheduled\">Initial multiplayer objective rescheduled</h3>\n<p>My initial game release was focus on the game core, graphisms and gameplay.</p>\n<p>I was unfortunately not ready enough to make the multi-player real-time part for the first week sprint but I have some though on the subject.<br>I was asking myself what are the best way to make the game synchronisation between clients while trying to keep as much client-side code as possible. I wanted a scalable decentralized game. I had some though on how to solve this issue. For instance, when a client shoots, he sends a “shoot” event with the timestamp, server just streams events (with a tick frequency) sent by clients and clients replay the game exactly the same way everywhere (using all these time-based events) with some interpolation with the current time.<br>I need to think more about this now, and try to use <a href=\"http://playframework.org/\">PlayFramework</a>.</p>\n<h2 id=\"source-code\">Source code</h2>\n<p><a href=\"http://github.com/gre/dta\">http://github.com/gre/dta</a></p>\n<p>**[EDIT] You may be mainly interested by the <a href=\"https://github.com/gre/dta/blob/master/app/assets/javascripts/main.js\">main.js</a>. It shows how powerful the even-driven programming is, for plugging components together.<br>**</p>\n<h2 id=\"special-thanks\">Special thanks</h2>\n<p><a href=\"http://twitter.com/mrspeaker\">@mrspeaker</a> for helping me with Three.js &amp; also collision system,<br><a href=\"http://twitter.com/mrdoob\">@mrdoob</a> &amp; <a href=\"http://twitter.com/aerotwist\">@aerotwist</a> for replying to my newbies questions,<br>guys on IRC (#three.js),<br>and of-course 7dfps guys.</p>\n","data":{"title":"How I learned Backbone.js, Three.js, GLSL in one week","author":"Gaetan","description":"I learned to use Backbone.js and Three.js (a famous library on top of WebGL) to make a FPS in only one week.","thumbnail":"/images/2012/07/dta1.png","layout":"post","permalink":"/2012/07/how-i-learned-backbone-js-three-js-glsl-in-one-week/","tags":["gamedev","GLSL","WebGL"]}},"__N_SSG":true}
<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="author" content="GaÃ«tan Renaudeau"/><meta name="description" content="This second article on Q will introduce you how to easily turn a callback API into a promise API using Deferred objects. It will also present the new W3C specification of Promise and finish with the implementation of Qimage, a simple Image Promise wrapper."/><meta name="keywords" content="AWOP, javascript, promise, Q, library"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@greweb"/><meta name="twitter:title" content="Qep2.: Deferred objects, Qimage"/><meta name="og:title" content="Qep2.: Deferred objects, Qimage"/><meta name="twitter:description" content="This second article on Q will introduce you how to easily turn a callback API into a promise API using Deferred objects. It will also present the new W3C specification of Promise and finish with the implementation of Qimage, a simple Image Promise wrapper."/><meta name="twitter:creator" content="@greweb"/><meta name="og:image" content="http://greweb.me//images/2013/07/qimage_then_thumbnail.jpg"/><meta name="twitter:image" content="http://greweb.me//images/2013/07/qimage_then_thumbnail.jpg"/><link rel="image_src" href="http://greweb.me//images/2013/07/qimage_then_thumbnail.jpg"/><title>@greweb - Qep2.: Deferred objects, Qimage</title><link href="http://fonts.googleapis.com/css?family=Fredericka+the+Great|Arapey|Roboto:400,700,400italic" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/styles/default.min.css"/><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/highlight.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/javascript.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/cpp.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/glsl.min.js"></script><link rel="stylesheet" href="/style/main.css"/><meta name="next-head-count" content="25"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-11911496995bbdbf52b1.js" defer=""></script><script src="/_next/static/chunks/framework-c93ed74a065331c4bd75.js" defer=""></script><script src="/_next/static/chunks/main-005750ed97c879f2d59b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-092526a60f8cb7d1b3d6.js" defer=""></script><script src="/_next/static/chunks/988-83f401159b53b3fa4628.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-cd0de5438621b7e4f378.js" defer=""></script><script src="/_next/static/ZTzDttmtW4P4GR6AmxZf1/_buildManifest.js" defer=""></script><script src="/_next/static/ZTzDttmtW4P4GR6AmxZf1/_ssgManifest.js" defer=""></script><style id="__jsx-2519965637">.block.jsx-2519965637{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.block.jsx-2519965637 .right.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637{margin-top:10px;}.block.jsx-2519965637 .social.jsx-2519965637 a.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637 img.jsx-2519965637{height:20px;}</style><style id="__jsx-3621368397">.container.jsx-3621368397{min-height:100vh;padding:0 0.5rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style id="__jsx-3469673304">html,body{padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}*{box-sizing:border-box;}a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}a:hover,a:active{-webkit-text-decoration:underline;text-decoration:underline;}</style></head><body><div id="__next"><div class="jsx-3621368397 container"><div id="container"><div id="main"><div id="content"><article><header><h1><a href="/">Qep2.: Deferred objects, Qimage</a></h1><time class="date" dateTime="2013-07-13">2013-07-13</time><span class="tags"><a class="tag">AWOP</a><a class="tag">javascript</a><a class="tag">promise</a><a class="tag">Q</a><a class="tag">library</a></span></header><div class="entry-content"><h1 id="a-world-of-promises-episode-2">A <a href="/pages/a-world-of-promises/">World Of Promises</a>, episode 2</h1>
<img src="/images/2013/07/qimage_then_thumbnail.jpg" alt="" class="thumbnail-right" style="width: 200px" />

<p><em>This second article on <a href="http://github.com/kriskowal/q">Q</a> will introduce you how to easily 
turn a callback API into a promise API using Deferred objects.
It will also present the new W3C specification of Promise and finish
with the implementation of <a href="http://github.com/gre/qimage">Qimage</a>, a simple Image Promise wrapper.</em></p>
<!--more-->

<h2 id="deferred-objects">Deferred objects</h2>
<p><a href="http://github.com/kriskowal/q">Q</a> splits the concept of Promise in two parts: one part is the <strong>Deferred object</strong>, another is the <strong>Promise object</strong>.</p>
<p>A <strong>Deferred object</strong> is an object which just aims to control the state of a Promise.
It allows to do one of the two following actions (one time only):</p>
<ul>
<li><code>.resolve(value)</code>: moving from <em>pending</em> to <strong><em>fulfilled</em> with a value</strong>.</li>
<li><code>.reject(error)</code>: moving from <em>pending</em> to <strong><em>rejected</em> with an error</strong>.</li>
</ul>
<img src="/images/2013/07/promise.png" style="max-width: 300px; width: 100%" />

<p>A <strong>Promise object</strong> can be obtained from a Deferred object via the <code>promise</code> field.
In <a href="http://github.com/kriskowal/q">Q</a>, a Promise is <strong>read-only</strong>: you can basically only do <code>.then</code> with it 
and there is no such <code>resolve</code> or <code>reject</code> method on a Promise.</p>
<blockquote>
<p>a Deferred is &quot;resolvable&quot;, a Promise is &quot;thenable&quot;.</p>
</blockquote>
<p><em><strong>N.B.</strong></em>: <em>this separation also exists in other languages but with different names (for instance in Scala: Promise / Future).</em></p>
<h3 id="qdefer"><code>Q.defer()</code></h3>
<p>The method Q.defer() will return a new <strong>Deferred object</strong> initialized in a <em>pending</em> state.</p>
<pre><code class="language-javascript">var d = Q.defer();
setTimeout(function () {
  d.resolve(42);
}, 500);
var promise = d.promise;
// ...
promise.then(function (value) {
  console.log(&quot;the universe = &quot;+value);
});
</code></pre>
<p>Note that the <a href="http://wiki.commonjs.org/wiki/Promises/A">Promises/A</a> spec only specifies the concept of <strong>Promise</strong>.
It does not defines the &quot;Deferred&quot; part.
Up to the Promise library to implement its own way of resolving / rejecting the value of a Promise.</p>
<p>There is also <a href="http://wiki.commonjs.org/wiki/Promises/B">Promises/B</a> and <a href="http://wiki.commonjs.org/wiki/Promises/D">Promises/D</a> to define that though.</p>
<h3 id="about-the-dompromise-specification">About the DOM.Promise specification</h3>
<p>a <a href="http://dom.spec.whatwg.org/#promises">new DOM specification draft</a> has born recently and is a bit different from the Q style,
the &quot;Deferred&quot; object (called a <strong>Resolver</strong>) is given as an argument of the function given at Promise instanciation.</p>
<pre><code class="language-javascript">var promise = new /*DOM.*/Promise(function (resolver) {
  setTimeout(function () {
    resolver.resolve(42);
  }, 500);
});
promise.then(function (value) {
  console.log(&quot;the universe = &quot;+value);
});
</code></pre>
<h2 id="qimage-wrapping-the-image-api">Qimage: Wrapping the Image API</h2>
<p>We will now show you how to easily <strong>wrap the DOM Image API into a Promise API with Q</strong>.
Before showing the implementation, let&#39;s explore the possibilities of such API.</p>
<p><strong><code>Qimage (url: String) =&gt; Promise[DOM Image]</code></strong></p>
<p>Here is how we want our <code>Qimage</code> API to look like:</p>
<pre><code class="language-javascript">var promise = Qimage(&quot;http://imagesource.com/image.png&quot;);
promise.then(function (image) {
  // image instanceof Image
}, function (error) {
  // error instanceof Error
});
</code></pre>
<p>We can use it like this:</p>
<pre><code class="language-javascript">Qimage(&quot;images/foo.png&quot;).then(function (img) {
  document.body.appendChild(img);
}, function (error) {
  document.body.innerHTML = &quot;Unable to load the image&quot;;
});
</code></pre>
<p>Now we define <code>Qimage</code> as a Promise library, <strong>we can then use all the power of Promises,
combine Promises together, chain different Promise APIs</strong>...</p>
<pre><code class="language-javascript">Q.all([
  Qimage(&quot;res1.png&quot;),
  Qimage(&quot;res2.png&quot;),
  Qimage(&quot;res3.png&quot;)
])
.spread(function (res1, res2, res3) {
  document.body.appendChild(res1);
  document.body.appendChild(res2);
  document.body.appendChild(res3);
});
</code></pre>
<p>This wrapper makes a simple but powerful Image Loading library module.</p>
<h3 id="implementation">Implementation</h3>
<p>Here is how <code>Qimage</code> works:</p>
<pre><code class="language-javascript">var Qimage = function (url) {
  var d = Q.defer();
  var img = new Image();
  img.onload = function () {
    d.resolve(img);
  };
  img.onabort = function (e) {
    d.reject(e);
  };
  img.onerror = function (err) {
    d.reject(err);
  };
  img.src = url;
  return d.promise;
};
</code></pre>
<p>...and that&#39;s it!</p>
<p>Note that <strong>the Deferred object is isolated</strong> in the <code>Qimage</code> function scope.</p>
<p>Only the (read-only) Promise is accessible from the outside when returned by the function.</p>
<p><strong>How simple is wrapping a callback API into a Promise API!</strong></p>
<hr>
<p><a href="http://github.com/gre/qimage">Qimage</a> is released as a micro-lib and available on <a href="http://github.com/gre/qimage">Github</a> and <a href="https://npmjs.org/package/qimage">NPM</a>.</p>
<h2 id="next-episode">Next episode</h2>
<p>Next episode will feature <strong><code>requestAnimationFrame</code></strong>, 
<em>a fundamental function generally used for performing efficient Javascript animations</em>.
We will show you <strong>QanimationFrame</strong> and how we can use it as a <strong>Promisified &quot;wait for DOM to be ready&quot; API</strong>.</p>
</div><footer><div class="jsx-2519965637 block"><img src="http://greweb.me/logo.svg" width="100" class="jsx-2519965637"/><div class="jsx-2519965637 right"><div class="jsx-2519965637 description">generative art, shaders, plotting with fountain pens</div><div class="jsx-2519965637 social"><a href="https://twitter.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitter.svg" class="jsx-2519965637"/></a><a href="https://instagram.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/instagram.svg" class="jsx-2519965637"/></a><a href="https://twitch.tv/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitch.svg" class="jsx-2519965637"/></a><a href="https://github.com/gre" class="jsx-2519965637"><img alt="" src="/icons/github.svg" class="jsx-2519965637"/></a><a href="https://opensea.io/greweb" class="jsx-2519965637"><img alt="" src="/icons/eth.svg" class="jsx-2519965637"/></a><a href="https://objkt.com/profile/tz1cgQAQfECg5bPASYTMyJ9QJQjSUi8rfL67" class="jsx-2519965637"><img alt="" src="/icons/tz.svg" class="jsx-2519965637"/></a><a href="https://fxhash.xyz/u/greweb" class="jsx-2519965637"><img alt="" src="/icons/tz.svg" class="jsx-2519965637"/></a><a href="https://greweb.itch.io" class="jsx-2519965637"><img alt="" src="/icons/iconmonstr-gamepad-3.svg" class="jsx-2519965637"/></a></div></div></div></footer></article></div></div></div><script>hljs.highlightAll();</script></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"2013-07-13-deferred","year":"2013","month":"07","day":"13","slug":"deferred","content":"\u003ch1 id=\"a-world-of-promises-episode-2\"\u003eA \u003ca href=\"/pages/a-world-of-promises/\"\u003eWorld Of Promises\u003c/a\u003e, episode 2\u003c/h1\u003e\n\u003cimg src=\"/images/2013/07/qimage_then_thumbnail.jpg\" alt=\"\" class=\"thumbnail-right\" style=\"width: 200px\" /\u003e\n\n\u003cp\u003e\u003cem\u003eThis second article on \u003ca href=\"http://github.com/kriskowal/q\"\u003eQ\u003c/a\u003e will introduce you how to easily \nturn a callback API into a promise API using Deferred objects.\nIt will also present the new W3C specification of Promise and finish\nwith the implementation of \u003ca href=\"http://github.com/gre/qimage\"\u003eQimage\u003c/a\u003e, a simple Image Promise wrapper.\u003c/em\u003e\u003c/p\u003e\n\u003c!--more--\u003e\n\n\u003ch2 id=\"deferred-objects\"\u003eDeferred objects\u003c/h2\u003e\n\u003cp\u003e\u003ca href=\"http://github.com/kriskowal/q\"\u003eQ\u003c/a\u003e splits the concept of Promise in two parts: one part is the \u003cstrong\u003eDeferred object\u003c/strong\u003e, another is the \u003cstrong\u003ePromise object\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eA \u003cstrong\u003eDeferred object\u003c/strong\u003e is an object which just aims to control the state of a Promise.\nIt allows to do one of the two following actions (one time only):\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e.resolve(value)\u003c/code\u003e: moving from \u003cem\u003epending\u003c/em\u003e to \u003cstrong\u003e\u003cem\u003efulfilled\u003c/em\u003e with a value\u003c/strong\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e.reject(error)\u003c/code\u003e: moving from \u003cem\u003epending\u003c/em\u003e to \u003cstrong\u003e\u003cem\u003erejected\u003c/em\u003e with an error\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cimg src=\"/images/2013/07/promise.png\" style=\"max-width: 300px; width: 100%\" /\u003e\n\n\u003cp\u003eA \u003cstrong\u003ePromise object\u003c/strong\u003e can be obtained from a Deferred object via the \u003ccode\u003epromise\u003c/code\u003e field.\nIn \u003ca href=\"http://github.com/kriskowal/q\"\u003eQ\u003c/a\u003e, a Promise is \u003cstrong\u003eread-only\u003c/strong\u003e: you can basically only do \u003ccode\u003e.then\u003c/code\u003e with it \nand there is no such \u003ccode\u003eresolve\u003c/code\u003e or \u003ccode\u003ereject\u003c/code\u003e method on a Promise.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003ea Deferred is \u0026quot;resolvable\u0026quot;, a Promise is \u0026quot;thenable\u0026quot;.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cem\u003e\u003cstrong\u003eN.B.\u003c/strong\u003e\u003c/em\u003e: \u003cem\u003ethis separation also exists in other languages but with different names (for instance in Scala: Promise / Future).\u003c/em\u003e\u003c/p\u003e\n\u003ch3 id=\"qdefer\"\u003e\u003ccode\u003eQ.defer()\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003eThe method Q.defer() will return a new \u003cstrong\u003eDeferred object\u003c/strong\u003e initialized in a \u003cem\u003epending\u003c/em\u003e state.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar d = Q.defer();\nsetTimeout(function () {\n  d.resolve(42);\n}, 500);\nvar promise = d.promise;\n// ...\npromise.then(function (value) {\n  console.log(\u0026quot;the universe = \u0026quot;+value);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNote that the \u003ca href=\"http://wiki.commonjs.org/wiki/Promises/A\"\u003ePromises/A\u003c/a\u003e spec only specifies the concept of \u003cstrong\u003ePromise\u003c/strong\u003e.\nIt does not defines the \u0026quot;Deferred\u0026quot; part.\nUp to the Promise library to implement its own way of resolving / rejecting the value of a Promise.\u003c/p\u003e\n\u003cp\u003eThere is also \u003ca href=\"http://wiki.commonjs.org/wiki/Promises/B\"\u003ePromises/B\u003c/a\u003e and \u003ca href=\"http://wiki.commonjs.org/wiki/Promises/D\"\u003ePromises/D\u003c/a\u003e to define that though.\u003c/p\u003e\n\u003ch3 id=\"about-the-dompromise-specification\"\u003eAbout the DOM.Promise specification\u003c/h3\u003e\n\u003cp\u003ea \u003ca href=\"http://dom.spec.whatwg.org/#promises\"\u003enew DOM specification draft\u003c/a\u003e has born recently and is a bit different from the Q style,\nthe \u0026quot;Deferred\u0026quot; object (called a \u003cstrong\u003eResolver\u003c/strong\u003e) is given as an argument of the function given at Promise instanciation.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar promise = new /*DOM.*/Promise(function (resolver) {\n  setTimeout(function () {\n    resolver.resolve(42);\n  }, 500);\n});\npromise.then(function (value) {\n  console.log(\u0026quot;the universe = \u0026quot;+value);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"qimage-wrapping-the-image-api\"\u003eQimage: Wrapping the Image API\u003c/h2\u003e\n\u003cp\u003eWe will now show you how to easily \u003cstrong\u003ewrap the DOM Image API into a Promise API with Q\u003c/strong\u003e.\nBefore showing the implementation, let\u0026#39;s explore the possibilities of such API.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ccode\u003eQimage (url: String) =\u0026gt; Promise[DOM Image]\u003c/code\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eHere is how we want our \u003ccode\u003eQimage\u003c/code\u003e API to look like:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar promise = Qimage(\u0026quot;http://imagesource.com/image.png\u0026quot;);\npromise.then(function (image) {\n  // image instanceof Image\n}, function (error) {\n  // error instanceof Error\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe can use it like this:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eQimage(\u0026quot;images/foo.png\u0026quot;).then(function (img) {\n  document.body.appendChild(img);\n}, function (error) {\n  document.body.innerHTML = \u0026quot;Unable to load the image\u0026quot;;\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eNow we define \u003ccode\u003eQimage\u003c/code\u003e as a Promise library, \u003cstrong\u003ewe can then use all the power of Promises,\ncombine Promises together, chain different Promise APIs\u003c/strong\u003e...\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003eQ.all([\n  Qimage(\u0026quot;res1.png\u0026quot;),\n  Qimage(\u0026quot;res2.png\u0026quot;),\n  Qimage(\u0026quot;res3.png\u0026quot;)\n])\n.spread(function (res1, res2, res3) {\n  document.body.appendChild(res1);\n  document.body.appendChild(res2);\n  document.body.appendChild(res3);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis wrapper makes a simple but powerful Image Loading library module.\u003c/p\u003e\n\u003ch3 id=\"implementation\"\u003eImplementation\u003c/h3\u003e\n\u003cp\u003eHere is how \u003ccode\u003eQimage\u003c/code\u003e works:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar Qimage = function (url) {\n  var d = Q.defer();\n  var img = new Image();\n  img.onload = function () {\n    d.resolve(img);\n  };\n  img.onabort = function (e) {\n    d.reject(e);\n  };\n  img.onerror = function (err) {\n    d.reject(err);\n  };\n  img.src = url;\n  return d.promise;\n};\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e...and that\u0026#39;s it!\u003c/p\u003e\n\u003cp\u003eNote that \u003cstrong\u003ethe Deferred object is isolated\u003c/strong\u003e in the \u003ccode\u003eQimage\u003c/code\u003e function scope.\u003c/p\u003e\n\u003cp\u003eOnly the (read-only) Promise is accessible from the outside when returned by the function.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eHow simple is wrapping a callback API into a Promise API!\u003c/strong\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003ca href=\"http://github.com/gre/qimage\"\u003eQimage\u003c/a\u003e is released as a micro-lib and available on \u003ca href=\"http://github.com/gre/qimage\"\u003eGithub\u003c/a\u003e and \u003ca href=\"https://npmjs.org/package/qimage\"\u003eNPM\u003c/a\u003e.\u003c/p\u003e\n\u003ch2 id=\"next-episode\"\u003eNext episode\u003c/h2\u003e\n\u003cp\u003eNext episode will feature \u003cstrong\u003e\u003ccode\u003erequestAnimationFrame\u003c/code\u003e\u003c/strong\u003e, \n\u003cem\u003ea fundamental function generally used for performing efficient Javascript animations\u003c/em\u003e.\nWe will show you \u003cstrong\u003eQanimationFrame\u003c/strong\u003e and how we can use it as a \u003cstrong\u003ePromisified \u0026quot;wait for DOM to be ready\u0026quot; API\u003c/strong\u003e.\u003c/p\u003e\n","data":{"title":"Qep2.: Deferred objects, Qimage","description":"This second article on Q will introduce you how to easily turn a callback API into a promise API using Deferred objects. It will also present the new W3C specification of Promise and finish with the implementation of Qimage, a simple Image Promise wrapper.","thumbnail":"/images/2013/07/qimage_then_thumbnail.jpg","author":"Gaetan","layout":"post","tags":["AWOP","javascript","promise","Q","library"]}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2013","month":"07","slug":"deferred"},"buildId":"ZTzDttmtW4P4GR6AmxZf1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>
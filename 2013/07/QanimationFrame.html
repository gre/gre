<!DOCTYPE html><html><head><meta charSet="utf-8"/><link rel="icon" href="/favicon.ico"/><meta name="author" content="GaÃ«tan Renaudeau"/><meta name="description" content="This third article on Q is a little parenthesis to the Qep articles series, featuring the requestAnimationFrame Javascript function and its general usage, and QanimationFrame, its Promisified version used as a &quot;wait for DOM to be ready&quot; API."/><meta name="keywords" content="AWOP, javascript, promise, Q, library"/><meta name="HandheldFriendly" content="True"/><meta name="MobileOptimized" content="320"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta name="twitter:card" content="summary"/><meta name="twitter:site" content="@greweb"/><meta name="twitter:title" content="Qep3.: QanimationFrame"/><meta name="og:title" content="Qep3.: QanimationFrame"/><meta name="twitter:description" content="This third article on Q is a little parenthesis to the Qep articles series, featuring the requestAnimationFrame Javascript function and its general usage, and QanimationFrame, its Promisified version used as a &quot;wait for DOM to be ready&quot; API."/><meta name="twitter:creator" content="@greweb"/><meta name="og:image" content="http://greweb.me//images/2013/07/qanimationframe.jpg"/><meta name="twitter:image" content="http://greweb.me//images/2013/07/qanimationframe.jpg"/><link rel="image_src" href="http://greweb.me//images/2013/07/qanimationframe.jpg"/><title>@greweb - Qep3.: QanimationFrame</title><link href="http://fonts.googleapis.com/css?family=Fredericka+the+Great|Arapey|Roboto:400,700,400italic" rel="stylesheet" type="text/css"/><link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/styles/default.min.css"/><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/highlight.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/javascript.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/cpp.min.js"></script><script src="https://unpkg.com/@highlightjs/cdn-assets@10.7.2/languages/glsl.min.js"></script><link rel="stylesheet" href="/style/main.css"/><meta name="next-head-count" content="25"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-682ed58dee9e3e5c50ef.js" defer=""></script><script src="/_next/static/chunks/framework-c93ed74a065331c4bd75.js" defer=""></script><script src="/_next/static/chunks/main-005750ed97c879f2d59b.js" defer=""></script><script src="/_next/static/chunks/pages/_app-092526a60f8cb7d1b3d6.js" defer=""></script><script src="/_next/static/chunks/988-83f401159b53b3fa4628.js" defer=""></script><script src="/_next/static/chunks/pages/%5Byear%5D/%5Bmonth%5D/%5Bslug%5D-0f67605ef98ac8184736.js" defer=""></script><script src="/_next/static/2MzmgTyBm9cyyiBUwgZS0/_buildManifest.js" defer=""></script><script src="/_next/static/2MzmgTyBm9cyyiBUwgZS0/_ssgManifest.js" defer=""></script><style id="__jsx-2519965637">.block.jsx-2519965637{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}.block.jsx-2519965637 .right.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637{margin-top:10px;}.block.jsx-2519965637 .social.jsx-2519965637 a.jsx-2519965637{padding:10px;}.block.jsx-2519965637 .social.jsx-2519965637 img.jsx-2519965637{height:20px;}</style><style id="__jsx-3621368397">.container.jsx-3621368397{min-height:100vh;padding:0 0.5rem;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style id="__jsx-3469673304">html,body{padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto, Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue, sans-serif;}*{box-sizing:border-box;}a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}a:hover,a:active{-webkit-text-decoration:underline;text-decoration:underline;}</style></head><body><div id="__next"><div class="jsx-3621368397 container"><div id="container"><div id="main"><div id="content"><article><header><h1><a href="/">Qep3.: QanimationFrame</a></h1><time class="date" dateTime="2013-07-17">2013-07-17</time><span class="tags"><a class="tag">AWOP</a><a class="tag">javascript</a><a class="tag">promise</a><a class="tag">Q</a><a class="tag">library</a></span></header><div class="entry-content"><h1 id="a-world-of-promises-episode-3">A <a href="/pages/a-world-of-promises/">World Of Promises</a>, episode 3</h1>
<img src="/images/2013/07/qanimationframe.jpg" alt="" class="thumbnail-left" style="width: 200px" />

<p><em>This third article on <a href="http://github.com/gre/qanimationframe">Q</a> is a little parenthesis to the Qep articles series,
featuring the <code>requestAnimationFrame</code> Javascript function and its general usage,
and <a href="http://github.com/gre/qanimationframe">QanimationFrame</a>, its Promisified version used as a &quot;wait for DOM to be ready&quot; API.</em></p>
<!--more-->

<h2 id="requestanimationframe"><code>requestAnimationFrame</code></h2>
<p><code>requestAnimationFrame</code> is a function which <strong>delays a Javascript function execution to the next browser render frame</strong>.
It takes one argument in parameters which is <strong>the function to call on next repaint</strong>.
<em>(N.B. there is not anymore a second DOM parameter like a few months ago, see the <a href="https://dvcs.w3.org/hg/webperf/raw-file/tip/specs/RequestAnimationFrame/Overview.html">spec</a>)</em></p>
<h3 id="for-animation-loop">...for animation loop</h3>
<p><code>requestAnimationFrame</code> helps to easily make a <strong>render loop</strong>:</p>
<pre><code class="language-javascript">(function loop(){
  requestAnimationFrame(loop);
  render();
}());
</code></pre>
<p>In that example, the <code>render</code> function can contains any Javascript code which updates
some graphics either using Canvas or DOM.</p>
<p>A good practice is to always <strong>compute time-relative</strong> animations and 
never assume the framerate to be constant.</p>
<pre><code class="language-javascript">function badRenderFunction() {
 someObject.x += 0.1; // 10 pixels per 100 frame.
 // not so good with non-constant framerate
}
</code></pre>
<pre><code class="language-javascript">var lastTime = Date.now();
function goodRenderFunction() {
 var now = Date.now();
 var delta = now-lastTime; // in milliseconds
 lastTime = now;
 someObject.x += 0.01 * delta; // 10 pixels per second
 // good because function of time
}
</code></pre>
<p>More information on <code>requestAnimationFrame</code> can be found <a href="http://creativejs.com/resources/requestanimationframe/">here</a> or <a href="http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/">here</a>.</p>
<h3 id="for-waiting-a-dom-update">...for waiting a DOM update</h3>
<p><strong>We will now focus on another interesting benefit of that function:</strong></p>
<p>Instead of using <code>requestAnimationFrame</code> for a render loop,
<strong>you can use it only once</strong> in order to <strong>wait for the next DOM update</strong>.</p>
<p>There is a lot of use-cases where you need to wait for the next DOM update 
and <code>requestAnimationFrame</code> is perfect for that.</p>
<p>Most of the code you can see on the internet rely on using a <code>setTimeout</code> with an arbitrary time
given in second parameters <em>(sometimes 30, sometimes 0 !?)</em>.
This is, in my humble opinion, a wrong approach because you will never know if the repaint has 
really been performed.</p>
<h2 id="qanimationframe">QanimationFrame</h2>
<p><code>QanimationFrame</code> is a function which takes a <strong>DOM Element</strong> in parameter and return a 
<strong>Promise of that &quot;ready&quot; DOM element</strong>.</p>
<p><strong><code>QanimationFrame (elt: DOM Element) =&gt; Promise[DOM Element]</code></strong></p>
<p><strong>N.B.:</strong> Even if <code>requestAnimationFrame</code> doesn&#39;t have anymore a second <em>DOM element</em> parameter,
I found it quite cool that you can give it as argument and retrieve it back to manipulate it.
It also makes the function more composable because it behaves like an identity Promise function.
We will also see benefits when using with other DOM Promise libraries.</p>
<h3 id="basic-example">Basic example</h3>
<pre><code class="language-javascript">var elt = document.createElement(&quot;div&quot;);
elt.innerHTML = &quot;Hello world&quot;;
// wait for the DOM to be ready before using the height
QanimationFrame(elt).then(function (elt) {
  console.log(&quot;height=&quot;+elt.offsetHeight);
});
</code></pre>
<h3 id="composability">Composability</h3>
<pre><code class="language-javascript">function createDivInBody (html) {
  var elt = document.createElement(&quot;div&quot;);
  elt.innerHTML = html;
  document.body.appendChild(elt);
  return elt;
}

var height = 
Q.fcall(createDivInBody, &quot;Hello world!&lt;br/&gt;How are you today?&quot;)
 .then(QanimationFrame)
 .then(function (elt) {
   return elt.offsetHeight;
 });

height.then(function(height){
  console.log(&quot;height is &quot;+height);
});
</code></pre>
<p>There is of-course a lot of more examples and use-cases of that library.</p>
<h2 id="next-episode">Next episode</h2>
<p>Next episode is a big one!</p>
<p>We will introduce you a Promisified animation library called <strong>Zanimo.js</strong> which
helps to chain different <strong>CSS transitions with only Promises</strong>.
It is very interoperable with any other Promise library,
meaning that you can easily chain Zanimo animations with other asynchronous actions.</p>
</div><footer><div class="jsx-2519965637 block"><img src="http://greweb.me/profile.jpg" width="100" class="jsx-2519965637"/><div class="jsx-2519965637 right"><div class="jsx-2519965637 description">creative coder experimenting with GLSL shaders, Rust, and fountain pens robot plots. infinite noise explorer.</div><div class="jsx-2519965637 social"><a href="https://twitter.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitter.svg" class="jsx-2519965637"/></a><a href="https://instagram.com/greweb" class="jsx-2519965637"><img alt="" src="/icons/instagram.svg" class="jsx-2519965637"/></a><a href="https://github.com/gre" class="jsx-2519965637"><img alt="" src="/icons/github.svg" class="jsx-2519965637"/></a><a href="https://twitch.tv/greweb" class="jsx-2519965637"><img alt="" src="/icons/twitch.svg" class="jsx-2519965637"/></a><a href="https://greweb.itch.io" class="jsx-2519965637"><img alt="" src="/icons/iconmonstr-gamepad-3.svg" class="jsx-2519965637"/></a><a href="https://hic.link/greweb" class="jsx-2519965637"><img alt="" src="/icons/hic.svg" class="jsx-2519965637"/></a></div></div></div></footer></article></div></div></div><script>hljs.highlightAll();</script></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"id":"2013-07-17-QanimationFrame","year":"2013","month":"07","day":"17","slug":"QanimationFrame","content":"\u003ch1 id=\"a-world-of-promises-episode-3\"\u003eA \u003ca href=\"/pages/a-world-of-promises/\"\u003eWorld Of Promises\u003c/a\u003e, episode 3\u003c/h1\u003e\n\u003cimg src=\"/images/2013/07/qanimationframe.jpg\" alt=\"\" class=\"thumbnail-left\" style=\"width: 200px\" /\u003e\n\n\u003cp\u003e\u003cem\u003eThis third article on \u003ca href=\"http://github.com/gre/qanimationframe\"\u003eQ\u003c/a\u003e is a little parenthesis to the Qep articles series,\nfeaturing the \u003ccode\u003erequestAnimationFrame\u003c/code\u003e Javascript function and its general usage,\nand \u003ca href=\"http://github.com/gre/qanimationframe\"\u003eQanimationFrame\u003c/a\u003e, its Promisified version used as a \u0026quot;wait for DOM to be ready\u0026quot; API.\u003c/em\u003e\u003c/p\u003e\n\u003c!--more--\u003e\n\n\u003ch2 id=\"requestanimationframe\"\u003e\u003ccode\u003erequestAnimationFrame\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003erequestAnimationFrame\u003c/code\u003e is a function which \u003cstrong\u003edelays a Javascript function execution to the next browser render frame\u003c/strong\u003e.\nIt takes one argument in parameters which is \u003cstrong\u003ethe function to call on next repaint\u003c/strong\u003e.\n\u003cem\u003e(N.B. there is not anymore a second DOM parameter like a few months ago, see the \u003ca href=\"https://dvcs.w3.org/hg/webperf/raw-file/tip/specs/RequestAnimationFrame/Overview.html\"\u003espec\u003c/a\u003e)\u003c/em\u003e\u003c/p\u003e\n\u003ch3 id=\"for-animation-loop\"\u003e...for animation loop\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003erequestAnimationFrame\u003c/code\u003e helps to easily make a \u003cstrong\u003erender loop\u003c/strong\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003e(function loop(){\n  requestAnimationFrame(loop);\n  render();\n}());\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn that example, the \u003ccode\u003erender\u003c/code\u003e function can contains any Javascript code which updates\nsome graphics either using Canvas or DOM.\u003c/p\u003e\n\u003cp\u003eA good practice is to always \u003cstrong\u003ecompute time-relative\u003c/strong\u003e animations and \nnever assume the framerate to be constant.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003efunction badRenderFunction() {\n someObject.x += 0.1; // 10 pixels per 100 frame.\n // not so good with non-constant framerate\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar lastTime = Date.now();\nfunction goodRenderFunction() {\n var now = Date.now();\n var delta = now-lastTime; // in milliseconds\n lastTime = now;\n someObject.x += 0.01 * delta; // 10 pixels per second\n // good because function of time\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eMore information on \u003ccode\u003erequestAnimationFrame\u003c/code\u003e can be found \u003ca href=\"http://creativejs.com/resources/requestanimationframe/\"\u003ehere\u003c/a\u003e or \u003ca href=\"http://www.paulirish.com/2011/requestanimationframe-for-smart-animating/\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003ch3 id=\"for-waiting-a-dom-update\"\u003e...for waiting a DOM update\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eWe will now focus on another interesting benefit of that function:\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eInstead of using \u003ccode\u003erequestAnimationFrame\u003c/code\u003e for a render loop,\n\u003cstrong\u003eyou can use it only once\u003c/strong\u003e in order to \u003cstrong\u003ewait for the next DOM update\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003eThere is a lot of use-cases where you need to wait for the next DOM update \nand \u003ccode\u003erequestAnimationFrame\u003c/code\u003e is perfect for that.\u003c/p\u003e\n\u003cp\u003eMost of the code you can see on the internet rely on using a \u003ccode\u003esetTimeout\u003c/code\u003e with an arbitrary time\ngiven in second parameters \u003cem\u003e(sometimes 30, sometimes 0 !?)\u003c/em\u003e.\nThis is, in my humble opinion, a wrong approach because you will never know if the repaint has \nreally been performed.\u003c/p\u003e\n\u003ch2 id=\"qanimationframe\"\u003eQanimationFrame\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003eQanimationFrame\u003c/code\u003e is a function which takes a \u003cstrong\u003eDOM Element\u003c/strong\u003e in parameter and return a \n\u003cstrong\u003ePromise of that \u0026quot;ready\u0026quot; DOM element\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e\u003ccode\u003eQanimationFrame (elt: DOM Element) =\u0026gt; Promise[DOM Element]\u003c/code\u003e\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eN.B.:\u003c/strong\u003e Even if \u003ccode\u003erequestAnimationFrame\u003c/code\u003e doesn\u0026#39;t have anymore a second \u003cem\u003eDOM element\u003c/em\u003e parameter,\nI found it quite cool that you can give it as argument and retrieve it back to manipulate it.\nIt also makes the function more composable because it behaves like an identity Promise function.\nWe will also see benefits when using with other DOM Promise libraries.\u003c/p\u003e\n\u003ch3 id=\"basic-example\"\u003eBasic example\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003evar elt = document.createElement(\u0026quot;div\u0026quot;);\nelt.innerHTML = \u0026quot;Hello world\u0026quot;;\n// wait for the DOM to be ready before using the height\nQanimationFrame(elt).then(function (elt) {\n  console.log(\u0026quot;height=\u0026quot;+elt.offsetHeight);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"composability\"\u003eComposability\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003efunction createDivInBody (html) {\n  var elt = document.createElement(\u0026quot;div\u0026quot;);\n  elt.innerHTML = html;\n  document.body.appendChild(elt);\n  return elt;\n}\n\nvar height = \nQ.fcall(createDivInBody, \u0026quot;Hello world!\u0026lt;br/\u0026gt;How are you today?\u0026quot;)\n .then(QanimationFrame)\n .then(function (elt) {\n   return elt.offsetHeight;\n });\n\nheight.then(function(height){\n  console.log(\u0026quot;height is \u0026quot;+height);\n});\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThere is of-course a lot of more examples and use-cases of that library.\u003c/p\u003e\n\u003ch2 id=\"next-episode\"\u003eNext episode\u003c/h2\u003e\n\u003cp\u003eNext episode is a big one!\u003c/p\u003e\n\u003cp\u003eWe will introduce you a Promisified animation library called \u003cstrong\u003eZanimo.js\u003c/strong\u003e which\nhelps to chain different \u003cstrong\u003eCSS transitions with only Promises\u003c/strong\u003e.\nIt is very interoperable with any other Promise library,\nmeaning that you can easily chain Zanimo animations with other asynchronous actions.\u003c/p\u003e\n","data":{"title":"Qep3.: QanimationFrame","description":"This third article on Q is a little parenthesis to the Qep articles series, featuring the requestAnimationFrame Javascript function and its general usage, and QanimationFrame, its Promisified version used as a \"wait for DOM to be ready\" API.","thumbnail":"/images/2013/07/qanimationframe.jpg","author":"Gaetan","layout":"post","tags":["AWOP","javascript","promise","Q","library"]}},"__N_SSG":true},"page":"/[year]/[month]/[slug]","query":{"year":"2013","month":"07","slug":"QanimationFrame"},"buildId":"2MzmgTyBm9cyyiBUwgZS0","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>